<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UMM FinOps Dashboard v2 - University of Michigan Medicine</title>
    <meta name="description" content="FinOps Cloud Cost Management Dashboard for University of Michigan Medicine Research Computing">
    <meta name="data-source" content="ServiceNow + Azure Cost Management">
    <meta name="last-verified" content="2026-01-13">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"
            crossorigin="anonymous"
            onerror="handleChartJSLoadError()"></script>
    <script>
        function handleChartJSLoadError() {
            console.error('[SECURITY] Chart.js failed to load from CDN');
            document.getElementById('chart-error').style.display = 'block';
            document.querySelectorAll('.chart-container').forEach(c => {
                c.innerHTML = '<div style="padding:40px;text-align:center;color:#666;">Chart unavailable</div>';
            });
        }
        window.addEventListener('load', function() {
            if (typeof Chart === 'undefined') handleChartJSLoadError();
        });
    </script>
    <style>
        :root {
            --umm-blue: #00274C;
            --umm-maize: #FFCB05;
            --umm-blue-light: #2F65A7;
            --umm-teal: #00B2A9;
            --umm-red: #9A3324;
            --umm-tan: #CFC096;
            --umm-sage: #75988D;
            --bg-light: #F5F7FA;
            --border-color: #E1E5EB;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg-light);
            color: var(--umm-blue);
        }

        .header {
            background: linear-gradient(135deg, var(--umm-blue) 0%, #003366 100%);
            color: white;
            padding: 16px 32px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        }

        .header-left { display: flex; align-items: center; gap: 16px; }

        .logo-placeholder {
            width: 50px; height: 50px;
            background: var(--umm-maize);
            border-radius: 8px;
            display: flex; align-items: center; justify-content: center;
            font-weight: bold; color: var(--umm-blue);
            font-size: 11px; text-align: center; line-height: 1.2;
        }

        .header-title h1 { font-size: 20px; font-weight: 600; }
        .header-title p { font-size: 12px; opacity: 0.85; }

        .header-right { display: flex; align-items: center; gap: 24px; }
        .header-info { font-size: 13px; text-align: right; }

        .persona-selector {
            display: flex; align-items: center; gap: 16px;
            background: var(--umm-maize);
            padding: 16px 28px; border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.25);
            margin-left: 40px;
        }
        .persona-selector label {
            font-size: 18px;
            font-weight: 800;
            text-transform: uppercase;
            color: var(--umm-blue);
            letter-spacing: 1px;
        }
        .persona-selector select {
            padding: 14px 24px;
            border: 3px solid var(--umm-blue);
            border-radius: 8px;
            font-size: 20px;
            font-weight: 700;
            background: white;
            color: var(--umm-blue);
            cursor: pointer;
            min-width: 320px;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%2300274C' stroke-width='3' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 12px center;
            background-size: 20px;
            padding-right: 45px;
        }
        .persona-selector select:focus {
            outline: none;
            box-shadow: 0 0 0 4px rgba(0,39,76,0.3);
        }
        .persona-selector select option {
            font-size: 18px;
            padding: 16px 20px;
            font-weight: 600;
            background: white;
            color: var(--umm-blue);
            line-height: 2;
        }
        .persona-selector select option:hover,
        .persona-selector select option:checked {
            background: var(--umm-maize);
            color: var(--umm-blue);
        }

        /* Global Filter Bar */
        .global-filter-bar {
            background: var(--umm-blue);
            padding: 12px 32px;
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            align-items: center;
            border-bottom: 3px solid var(--umm-maize);
        }

        .global-filter-bar .filter-group {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .global-filter-bar .filter-group label {
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
            color: rgba(255,255,255,0.7);
        }

        .global-filter-bar .filter-group select {
            padding: 6px 10px;
            border: 1px solid rgba(255,255,255,0.3);
            border-radius: 4px;
            font-size: 12px;
            min-width: 160px;
            background: rgba(255,255,255,0.95);
            color: var(--umm-blue);
        }

        .global-filter-bar .filter-reset {
            padding: 6px 14px;
            background: var(--umm-maize);
            color: var(--umm-blue);
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 11px;
            font-weight: 600;
            margin-top: 14px;
        }

        .global-filter-bar .filter-reset:hover {
            background: #e6b800;
        }

        .active-filters-display {
            background: rgba(255,203,5,0.15);
            padding: 8px 32px;
            font-size: 12px;
            color: var(--umm-blue);
            display: none;
        }

        .active-filters-display.visible {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .filter-tag {
            background: var(--umm-maize);
            color: var(--umm-blue);
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }

        .filter-tag .remove {
            cursor: pointer;
            font-weight: bold;
        }

        .nav-tabs {
            background: white;
            padding: 0 32px;
            display: flex;
            gap: 0;
            border-bottom: 1px solid var(--border-color);
        }

        .nav-tab {
            padding: 14px 24px;
            cursor: pointer;
            border: none;
            background: transparent;
            font-size: 14px;
            font-weight: 500;
            color: var(--umm-blue);
            opacity: 0.7;
            transition: all 0.2s;
            border-bottom: 3px solid transparent;
            margin-bottom: -1px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .nav-tab:hover { opacity: 1; background: rgba(0, 39, 76, 0.05); }

        .nav-tab.active {
            opacity: 1;
            border-bottom-color: var(--umm-blue);
            background: rgba(255, 203, 5, 0.1);
        }

        .nav-tab .audience-hint {
            font-size: 10px; padding: 2px 6px; border-radius: 3px;
            background: var(--bg-light); color: #666; font-weight: normal;
        }

        .nav-tab.active .audience-hint {
            background: var(--umm-maize); color: var(--umm-blue);
        }

        .main-content { padding: 24px 32px; max-width: 1600px; margin: 0 auto; }

        .page { display: none; }
        .page.active { display: block; }

        .page-header {
            margin-bottom: 24px;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
        }

        .page-header-left h2 { font-size: 24px; color: var(--umm-blue); margin-bottom: 4px; }
        .page-header-left p { color: #666; font-size: 14px; }

        .audience-badge {
            display: inline-flex; align-items: center; gap: 6px;
            padding: 8px 14px; border-radius: 20px;
            font-size: 12px; font-weight: 500;
        }

        .audience-badge.leadership { background: #E3F2FD; color: #1565C0; border: 1px solid #90CAF9; }
        .audience-badge.pi { background: #E8F5E9; color: #2E7D32; border: 1px solid #A5D6A7; }
        .audience-badge.ops { background: #FFF3E0; color: #E65100; border: 1px solid #FFCC80; }
        .audience-badge.governance { background: #F3E5F5; color: #7B1FA2; border: 1px solid #CE93D8; }

        .pi-context-banner {
            background: linear-gradient(135deg, #E8F5E9 0%, #C8E6C9 100%);
            border: 1px solid #A5D6A7;
            border-radius: 8px;
            padding: 16px 20px;
            margin-bottom: 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .pi-context-info { display: flex; align-items: center; gap: 16px; }

        .pi-avatar {
            width: 48px; height: 48px; border-radius: 50%;
            background: var(--umm-blue); color: white;
            display: flex; align-items: center; justify-content: center;
            font-weight: 600; font-size: 18px;
        }

        .pi-details h3 { font-size: 16px; color: var(--umm-blue); }
        .pi-details p { font-size: 13px; color: #666; }

        .pi-context-note {
            font-size: 12px; color: #666; font-style: italic;
            max-width: 300px; text-align: right;
        }

        .kpi-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 24px;
        }

        .kpi-card {
            background: white;
            padding: 20px 24px;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.08);
            border-left: 4px solid var(--umm-maize);
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .kpi-card:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.12); }
        .kpi-card.alert { border-left-color: var(--umm-red); }
        .kpi-card.success { border-left-color: var(--umm-teal); }
        .kpi-card.info { border-left-color: var(--umm-blue-light); }
        .kpi-card.critical { border-left-color: #C62828; background: #FFEBEE; }

        .kpi-label { font-size: 12px; color: #666; text-transform: uppercase; font-weight: 600; margin-bottom: 8px; }
        .kpi-value { font-size: 28px; font-weight: 700; color: var(--umm-blue); }
        .kpi-subtext { font-size: 12px; color: #888; margin-top: 4px; }

        .kpi-trend {
            display: inline-flex; align-items: center;
            font-size: 12px; margin-top: 6px;
            padding: 2px 8px; border-radius: 12px;
        }
        .kpi-trend.up { background: #FFEBEE; color: var(--umm-red); }
        .kpi-trend.down { background: #E8F5E9; color: #2E7D32; }

        .card {
            background: white;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.08);
            margin-bottom: 24px;
        }

        .card-header {
            padding: 16px 20px;
            border-bottom: 1px solid var(--border-color);
            font-weight: 600;
            color: var(--umm-blue);
            font-size: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .card-header .badge {
            background: var(--umm-maize);
            color: var(--umm-blue);
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
        }

        .card-body { padding: 20px; }

        .data-table { width: 100%; border-collapse: collapse; font-size: 13px; }

        .data-table th {
            text-align: left;
            padding: 12px 16px;
            background: var(--bg-light);
            font-weight: 600;
            color: var(--umm-blue);
            border-bottom: 2px solid var(--umm-maize);
            font-size: 11px;
            text-transform: uppercase;
            white-space: nowrap;
        }

        .data-table td { padding: 12px 16px; border-bottom: 1px solid var(--border-color); }
        .data-table tr:hover { background: rgba(255, 203, 5, 0.05); }
        .data-table .text-right { text-align: right; }

        .status-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
        }

        .status-active { background: #E8F5E9; color: #2E7D32; }
        .status-completed { background: #E3F2FD; color: #1565C0; }
        .status-expiring { background: #FFF3E0; color: #E65100; }
        .status-expired { background: #FFEBEE; color: #C62828; }
        .status-open { background: #FFEBEE; color: #C62828; }
        .status-closed { background: #E8F5E9; color: #2E7D32; }
        .status-pending { background: #FFF3E0; color: #E65100; }

        .budget-status-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
        }

        .budget-overspend { background: #C62828; color: white; }
        .budget-atrisk { background: #E65100; color: white; }
        .budget-ontrack { background: #2E7D32; color: white; }
        .budget-underutilized { background: #1565C0; color: white; }

        .severity-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .severity-critical { background: #C62828; color: white; }
        .severity-high { background: #E65100; color: white; }
        .severity-medium { background: #F9A825; color: #333; }
        .severity-low { background: #9E9E9E; color: white; }

        .issue-type-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
        }

        .issue-security { background: #C62828; color: white; }
        .issue-cost { background: #1565C0; color: white; }
        .issue-hygiene { background: #6A1B9A; color: white; }

        .env-type-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
        }

        .env-ave { background: var(--umm-blue); color: white; }
        .env-standard { background: var(--umm-blue-light); color: white; }

        .servicenow-ticket {
            display: inline-block;
            padding: 4px 10px;
            background: #E3F2FD;
            color: #1565C0;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
            font-family: 'Consolas', 'Monaco', monospace;
            border: 1px solid #90CAF9;
        }

        .grant-name {
            display: inline-block;
            padding: 4px 10px;
            background: #FFF3E0;
            color: #E65100;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
            border: 1px solid #FFCC80;
            max-width: 200px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .irb-number {
            display: inline-block;
            padding: 4px 10px;
            background: #F3E5F5;
            color: #7B1FA2;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
            font-family: 'Consolas', 'Monaco', monospace;
            border: 1px solid #CE93D8;
        }

        .irb-status-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
        }

        .irb-approved { background: #E8F5E9; color: #2E7D32; border: 1px solid #A5D6A7; }
        .irb-pending { background: #FFF8E1; color: #F57F17; border: 1px solid #FFE082; }
        .irb-under-review { background: #E3F2FD; color: #1565C0; border: 1px solid #90CAF9; }
        .irb-exempt { background: #ECEFF1; color: #546E7A; border: 1px solid #B0BEC5; }
        .irb-closed { background: #FAFAFA; color: #757575; border: 1px solid #E0E0E0; }

        /* Analysis Section Styles */
        .analysis-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
            margin-bottom: 24px;
        }

        .analysis-card {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            border: 1px solid #dee2e6;
        }

        .analysis-title {
            font-size: 12px;
            font-weight: 600;
            color: #666;
            text-transform: uppercase;
            margin-bottom: 8px;
        }

        .analysis-value {
            font-size: 28px;
            font-weight: 700;
            color: var(--umm-blue);
            margin-bottom: 4px;
        }

        .analysis-value.positive { color: #2E7D32; }
        .analysis-value.negative { color: #C62828; }

        .analysis-detail {
            font-size: 12px;
            color: #888;
        }

        .analysis-breakdown {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 24px;
            border-top: 1px solid #e0e0e0;
            padding-top: 20px;
        }

        .breakdown-section h4 {
            font-size: 14px;
            font-weight: 600;
            color: var(--umm-blue);
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 2px solid var(--umm-maize);
        }

        .breakdown-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .breakdown-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            background: #f8f9fa;
            border-radius: 6px;
            font-size: 13px;
        }

        .breakdown-item .label {
            font-weight: 500;
            color: var(--umm-blue);
        }

        .breakdown-item .value {
            font-weight: 600;
            color: #333;
        }

        .breakdown-item .bar-container {
            flex: 1;
            margin: 0 12px;
            height: 8px;
            background: #e0e0e0;
            border-radius: 4px;
            overflow: hidden;
        }

        .breakdown-item .bar {
            height: 100%;
            border-radius: 4px;
            background: var(--umm-blue-light);
        }

        @media (max-width: 1200px) {
            .analysis-grid { grid-template-columns: repeat(2, 1fr); }
            .analysis-breakdown { grid-template-columns: 1fr; }
        }

        .progress-bar {
            height: 8px;
            background: #E1E5EB;
            border-radius: 4px;
            overflow: hidden;
            margin-top: 4px;
        }

        .progress-fill { height: 100%; border-radius: 4px; transition: width 0.3s; }
        .progress-fill.good { background: var(--umm-teal); }
        .progress-fill.warning { background: #FF9800; }
        .progress-fill.danger { background: var(--umm-red); }

        .grid-2 { display: grid; grid-template-columns: repeat(2, 1fr); gap: 24px; }
        .grid-3 { display: grid; grid-template-columns: repeat(3, 1fr); gap: 24px; }

        @media (max-width: 1200px) {
            .grid-2, .grid-3 { grid-template-columns: 1fr; }
        }

        .chart-container { position: relative; height: 300px; }
        .chart-container.tall { height: 350px; }

        .matrix-table { width: 100%; border-collapse: collapse; font-size: 13px; }
        .matrix-table th, .matrix-table td {
            padding: 10px 14px;
            text-align: right;
            border: 1px solid var(--border-color);
        }
        .matrix-table th { background: var(--umm-blue); color: white; font-weight: 600; }
        .matrix-table th:first-child, .matrix-table td:first-child { text-align: left; }
        .matrix-table .row-header { background: var(--bg-light); font-weight: 600; }
        .matrix-table .subtotal { background: rgba(255, 203, 5, 0.15); font-weight: 600; }

        .variance-positive { color: var(--umm-teal); }
        .variance-negative { color: var(--umm-red); }

        .expandable-row { cursor: pointer; }
        .expandable-row:hover { background: rgba(0, 39, 76, 0.05); }
        .expand-icon { display: inline-block; width: 16px; transition: transform 0.2s; }
        .expand-icon.expanded { transform: rotate(90deg); }
        .child-row { display: none; }
        .child-row.visible { display: table-row; }

        .config-notice {
            background: #F3E5F5;
            border: 1px solid #CE93D8;
            border-radius: 8px;
            padding: 12px 16px;
            margin-bottom: 20px;
            font-size: 13px;
            color: #7B1FA2;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .toggle-switch { display: flex; align-items: center; gap: 8px; font-size: 13px; }
        .toggle-switch input[type="checkbox"] {
            width: 40px; height: 20px;
            appearance: none;
            background: #ccc;
            border-radius: 10px;
            position: relative;
            cursor: pointer;
            transition: background 0.2s;
        }
        .toggle-switch input[type="checkbox"]:checked { background: var(--umm-teal); }
        .toggle-switch input[type="checkbox"]::before {
            content: '';
            position: absolute;
            width: 16px; height: 16px;
            background: white;
            border-radius: 50%;
            top: 2px; left: 2px;
            transition: left 0.2s;
        }
        .toggle-switch input[type="checkbox"]:checked::before { left: 22px; }

        .footer {
            text-align: center;
            padding: 20px;
            color: #888;
            font-size: 12px;
            border-top: 1px solid var(--border-color);
            margin-top: 40px;
        }

        .table-scroll { max-height: 400px; overflow-y: auto; }

        .traceability-bar {
            background: #E8F5E9;
            border-bottom: 1px solid #C8E6C9;
            padding: 8px 32px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 12px;
            color: #2E7D32;
        }

        .trace-item { display: flex; align-items: center; gap: 6px; }
        .trace-icon {
            width: 16px; height: 16px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-size: 10px;
        }
        .trace-icon.verified { background: #2E7D32; color: white; }
        .trace-icon.synced { background: #1565C0; color: white; }
        .trace-icon.approved { background: #6A1B9A; color: white; }

        .data-freshness {
            display: inline-flex; align-items: center; gap: 4px;
            padding: 2px 8px; background: white;
            border-radius: 4px; font-weight: 500;
        }

        .freshness-dot {
            width: 8px; height: 8px; border-radius: 50%;
            background: #4CAF50;
            animation: pulse 2s infinite;
        }

        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }

        .loading-overlay {
            display: none;
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(255,255,255,0.9);
            z-index: 9999;
            justify-content: center;
            align-items: center;
            flex-direction: column;
        }

        .loading-spinner {
            width: 48px; height: 48px;
            border: 4px solid var(--umm-maize);
            border-top-color: var(--umm-blue);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin { to { transform: rotate(360deg); } }
        .loading-text { margin-top: 16px; color: var(--umm-blue); font-weight: 500; }

        #chart-error {
            display: none;
            background: #FFF3E0;
            border: 1px solid #FFB74D;
            padding: 16px; margin: 16px;
            border-radius: 8px;
            color: #E65100;
            text-align: center;
        }

        .triage-summary {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 16px;
            margin-bottom: 24px;
        }

        .triage-card {
            background: white;
            border-radius: 8px;
            padding: 16px;
            text-align: center;
            box-shadow: 0 1px 3px rgba(0,0,0,0.08);
            border-top: 4px solid;
        }

        .triage-card.critical { border-color: #C62828; }
        .triage-card.high { border-color: #E65100; }
        .triage-card.medium { border-color: #F9A825; }
        .triage-card.low { border-color: #9E9E9E; }

        .triage-count { font-size: 36px; font-weight: 700; color: var(--umm-blue); }
        .triage-label { font-size: 12px; color: #666; text-transform: uppercase; font-weight: 600; }

        @media print {
            .nav-tabs, .global-filter-bar, .traceability-bar, .persona-selector { display: none; }
            .page { display: block !important; page-break-after: always; }
        }
    </style>
</head>
<body>
    <div class="loading-overlay" id="loading-overlay">
        <div class="loading-spinner"></div>
        <div class="loading-text">Loading dashboard data...</div>
    </div>

    <div id="chart-error">Charts could not load. Please check your internet connection.</div>

    <header class="header">
        <div class="header-left">
            <div class="logo-placeholder">Michigan<br>Medicine</div>
            <div class="header-title">
                <h1>FinOps Cloud Cost Management</h1>
                <p>University of Michigan Medicine - Research Computing</p>
            </div>
            <div class="persona-selector">
                <label>VIEW AS:</label>
                <select id="persona-select" onchange="switchPersona()">
                    <option value="finance">Finance & Research Operations</option>
                    <option value="pi">Principal Investigator (PI)</option>
                    <option value="cloudops">Cloud Operations / FinOps</option>
                    <option value="governance">Governance (Dept. Admin)</option>
                </select>
            </div>
        </div>
        <div class="header-right">
            <div class="header-info">
                <div>Report Generated: <span id="currentDate"></span></div>
                <div>Data Source: Azure Cost Management + ServiceNow</div>
            </div>
        </div>
    </header>

    <div class="traceability-bar">
        <div class="trace-item">
            <span class="trace-icon verified">&#10003;</span>
            <span><strong>Data Verified:</strong> ServiceNow CMDB + Azure Cost Management API</span>
        </div>
        <div class="trace-item">
            <span class="trace-icon synced">&#8635;</span>
            <span><strong>Last Sync:</strong> <span id="lastSyncTime">--</span></span>
            <span class="data-freshness"><span class="freshness-dot"></span> Live</span>
        </div>
        <div class="trace-item">
            <span class="trace-icon approved">&#9679;</span>
            <span><strong>Approved By:</strong> FinOps Team | <span id="approvalDate">--</span></span>
        </div>
    </div>

    <!-- Global Filter Bar -->
    <div class="global-filter-bar">
        <div class="filter-group">
            <label>Department</label>
            <select id="global-filter-dept" onchange="applyGlobalFilters()">
                <option value="all">All Departments</option>
            </select>
        </div>
        <div class="filter-group">
            <label>Principal Investigator</label>
            <select id="global-filter-pi" onchange="applyGlobalFilters()">
                <option value="all">All PIs</option>
            </select>
        </div>
        <div class="filter-group">
            <label>Project Status</label>
            <select id="global-filter-status" onchange="applyGlobalFilters()">
                <option value="all">All Statuses</option>
                <option value="Active">Active</option>
                <option value="Completed">Completed</option>
                <option value="Expiring">Expiring Soon</option>
            </select>
        </div>
        <div class="filter-group">
            <label>Budget Status</label>
            <select id="global-filter-budget" onchange="applyGlobalFilters()">
                <option value="all">All Budget Statuses</option>
                <option value="overspend">Over Budget</option>
                <option value="atrisk">At Risk (>80%)</option>
                <option value="ontrack">On Track</option>
                <option value="underutilized">Underutilized (<30%)</option>
            </select>
        </div>
        <div class="filter-group">
            <label>Environment Type</label>
            <select id="global-filter-env" onchange="applyGlobalFilters()">
                <option value="all">All Types</option>
                <option value="AVE">AVE (PHI)</option>
                <option value="Standard">Standard</option>
            </select>
        </div>
        <div class="filter-group">
            <label>Date Range</label>
            <select id="global-filter-date" onchange="applyGlobalFilters()">
                <option value="all">All Time (12 Months)</option>
                <option value="1">Last 1 Month</option>
                <option value="3">Last 3 Months</option>
                <option value="6">Last 6 Months</option>
                <option value="ytd">Year to Date</option>
            </select>
        </div>
        <button class="filter-reset" onclick="resetGlobalFilters()">Reset All Filters</button>
    </div>

    <!-- Active Filters Display -->
    <div class="active-filters-display" id="active-filters-display">
        <strong>Active Filters:</strong>
        <span id="active-filter-tags"></span>
    </div>

    <nav class="nav-tabs" id="nav-tabs"></nav>

    <main class="main-content">
        <!-- PAGE: Finance & Research Operations -->
        <div id="page-finance" class="page">
            <div class="page-header">
                <div class="page-header-left">
                    <h2>Finance & Research Operations</h2>
                    <p>Central oversight of cloud spending across departments, divisions, and PIs</p>
                </div>
                <div class="audience-badge leadership">
                    <span>&#128188;</span> For: CIO / CMIO / CRO / Research Administration
                </div>
            </div>

            <div class="kpi-row">
                <div class="kpi-card">
                    <div class="kpi-label">Total YTD Spend</div>
                    <div class="kpi-value" id="kpi-finance-ytd">--</div>
                    <div class="kpi-trend up" id="kpi-finance-trend">+12% vs prior</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-label">Total Budget</div>
                    <div class="kpi-value" id="kpi-finance-budget">--</div>
                    <div class="kpi-subtext">Across all grants</div>
                </div>
                <div class="kpi-card success">
                    <div class="kpi-label">Budget Variance</div>
                    <div class="kpi-value" id="kpi-finance-variance">--</div>
                    <div class="kpi-subtext" id="kpi-finance-variance-sub">Under budget</div>
                </div>
                <div class="kpi-card alert">
                    <div class="kpi-label">Over Budget PIs</div>
                    <div class="kpi-value" id="kpi-finance-overspend">--</div>
                    <div class="kpi-subtext">Requires attention</div>
                </div>
                <div class="kpi-card info">
                    <div class="kpi-label">Completed Projects</div>
                    <div class="kpi-value" id="kpi-finance-completed">--</div>
                    <div class="kpi-subtext">This fiscal year</div>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    Cost by Department / PI
                    <span class="badge" id="finance-matrix-badge">Drill-down Enabled</span>
                </div>
                <div class="card-body">
                    <div class="table-scroll">
                        <table class="matrix-table" id="finance-matrix-table">
                            <thead>
                                <tr>
                                    <th>Department / PI</th>
                                    <th>Total Cost</th>
                                    <th>Budget</th>
                                    <th>Variance</th>
                                    <th>% Used</th>
                                    <th>Budget Status</th>
                                    <th>Projects</th>
                                    <th>End Date</th>
                                </tr>
                            </thead>
                            <tbody id="finance-matrix-tbody"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div class="grid-2">
                <div class="card">
                    <div class="card-header">Monthly Spend Trend</div>
                    <div class="card-body">
                        <div class="chart-container tall"><canvas id="financeSpendTrendChart"></canvas></div>
                    </div>
                </div>
                <div class="card">
                    <div class="card-header">Budget vs Actuals by Department</div>
                    <div class="card-body">
                        <div class="chart-container tall"><canvas id="financeBudgetChart"></canvas></div>
                    </div>
                </div>
            </div>

            <!-- Cost Analysis Section -->
            <div class="card">
                <div class="card-header">
                    Cost Analysis & Insights
                    <span class="badge" style="background: var(--umm-teal); color: white;">Analytics</span>
                </div>
                <div class="card-body">
                    <div class="analysis-grid">
                        <div class="analysis-card">
                            <div class="analysis-title">Month-over-Month Change</div>
                            <div class="analysis-value" id="analysis-mom">--</div>
                            <div class="analysis-detail" id="analysis-mom-detail">vs previous month</div>
                        </div>
                        <div class="analysis-card">
                            <div class="analysis-title">Average Monthly Spend</div>
                            <div class="analysis-value" id="analysis-avg-spend">--</div>
                            <div class="analysis-detail" id="analysis-avg-detail">per month</div>
                        </div>
                        <div class="analysis-card">
                            <div class="analysis-title">Projected Year-End</div>
                            <div class="analysis-value" id="analysis-projected">--</div>
                            <div class="analysis-detail" id="analysis-projected-detail">at current rate</div>
                        </div>
                        <div class="analysis-card">
                            <div class="analysis-title">Cost per Project</div>
                            <div class="analysis-value" id="analysis-per-project">--</div>
                            <div class="analysis-detail" id="analysis-per-project-detail">average</div>
                        </div>
                    </div>
                    <div class="analysis-breakdown">
                        <div class="breakdown-section">
                            <h4>Top Spending Departments</h4>
                            <div id="top-departments-list" class="breakdown-list"></div>
                        </div>
                        <div class="breakdown-section">
                            <h4>Cost by Service Category</h4>
                            <div id="service-category-list" class="breakdown-list"></div>
                        </div>
                        <div class="breakdown-section">
                            <h4>Budget Risk Summary</h4>
                            <div id="budget-risk-list" class="breakdown-list"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    All Projects Detail
                    <span class="badge" id="finance-projects-badge">0 Projects</span>
                </div>
                <div class="card-body">
                    <div class="table-scroll">
                        <table class="data-table" id="finance-projects-table">
                            <thead>
                                <tr>
                                    <th>ServiceNow #</th>
                                    <th>Project Name</th>
                                    <th>Grant</th>
                                    <th>IRB #</th>
                                    <th>IRB Status</th>
                                    <th>PI</th>
                                    <th>Department</th>
                                    <th>Type</th>
                                    <th class="text-right">Monthly Cost</th>
                                    <th>Budget Status</th>
                                    <th>End Date</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody id="finance-projects-tbody"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- PAGE: PI Personal View -->
        <div id="page-pi" class="page">
            <div class="page-header">
                <div class="page-header-left">
                    <h2>My Research Computing</h2>
                    <p>Your personal cloud environments, costs, and grant budget status</p>
                </div>
                <div class="audience-badge pi">
                    <span>&#128300;</span> For: Principal Investigators
                </div>
            </div>

            <div class="pi-context-banner">
                <div class="pi-context-info">
                    <div class="pi-avatar" id="pi-avatar">SC</div>
                    <div class="pi-details">
                        <h3 id="pi-name">Dr. Sarah Chen</h3>
                        <p id="pi-dept">Department of Cardiology</p>
                    </div>
                </div>
                <div class="pi-context-note">
                    Viewing only your projects and grants. Contact Research Admin for cross-PI reporting.
                </div>
            </div>

            <div class="kpi-row">
                <div class="kpi-card">
                    <div class="kpi-label">My Total Spend (YTD)</div>
                    <div class="kpi-value" id="kpi-pi-spend">--</div>
                    <div class="kpi-subtext">Across all my grants</div>
                </div>
                <div class="kpi-card success">
                    <div class="kpi-label">Budget Remaining</div>
                    <div class="kpi-value" id="kpi-pi-remaining">--</div>
                    <div class="kpi-subtext" id="kpi-pi-pct">--</div>
                </div>
                <div class="kpi-card alert">
                    <div class="kpi-label">Expiring Soon</div>
                    <div class="kpi-value" id="kpi-pi-expiring">--</div>
                    <div class="kpi-subtext">Within 30 days</div>
                </div>
                <div class="kpi-card info">
                    <div class="kpi-label">Active Projects</div>
                    <div class="kpi-value" id="kpi-pi-projects">--</div>
                    <div class="kpi-subtext">Cloud environments</div>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    My Research Projects
                    <span class="badge" id="pi-project-count">0 Projects</span>
                </div>
                <div class="card-body">
                    <div class="table-scroll">
                        <table class="data-table" id="pi-projects-table">
                            <thead>
                                <tr>
                                    <th>ServiceNow #</th>
                                    <th>Project Name</th>
                                    <th>Grant</th>
                                    <th>IRB #</th>
                                    <th>IRB Status</th>
                                    <th>Type</th>
                                    <th class="text-right">Monthly Cost</th>
                                    <th>Budget Usage</th>
                                    <th>End Date</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody id="pi-projects-tbody"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-header">My Grants Summary</div>
                <div class="card-body">
                    <table class="data-table" id="pi-grants-table">
                        <thead>
                            <tr>
                                <th>Grant Name</th>
                                <th class="text-right">Spent</th>
                                <th class="text-right">Budget</th>
                                <th class="text-right">Remaining</th>
                                <th>Usage</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="pi-grants-tbody"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- PAGE: Cloud Operations -->
        <div id="page-cloudops" class="page">
            <div class="page-header">
                <div class="page-header-left">
                    <h2>Cloud Operations & Compliance</h2>
                    <p>Compliance triage and remediation for IT, security, and FinOps teams</p>
                </div>
                <div class="audience-badge ops">
                    <span>&#9881;</span> For: Cloud Ops / IT / Security
                </div>
            </div>

            <div class="triage-summary">
                <div class="triage-card critical">
                    <div class="triage-count" id="triage-critical">0</div>
                    <div class="triage-label">Critical</div>
                </div>
                <div class="triage-card high">
                    <div class="triage-count" id="triage-high">0</div>
                    <div class="triage-label">High</div>
                </div>
                <div class="triage-card medium">
                    <div class="triage-count" id="triage-medium">0</div>
                    <div class="triage-label">Medium</div>
                </div>
                <div class="triage-card low">
                    <div class="triage-count" id="triage-low">0</div>
                    <div class="triage-label">Low</div>
                </div>
            </div>

            <div class="kpi-row">
                <div class="kpi-card alert">
                    <div class="kpi-label">Open Issues</div>
                    <div class="kpi-value" id="kpi-ops-issues">--</div>
                    <div class="kpi-subtext">Requires remediation</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-label">Total Environments</div>
                    <div class="kpi-value" id="kpi-ops-envs">--</div>
                    <div class="kpi-subtext">Active</div>
                </div>
                <div class="kpi-card success">
                    <div class="kpi-label">Compliance Rate</div>
                    <div class="kpi-value" id="kpi-ops-rate">--</div>
                    <div class="kpi-subtext">In compliance</div>
                </div>
                <div class="kpi-card info">
                    <div class="kpi-label">Est. Savings</div>
                    <div class="kpi-value" id="kpi-ops-savings">--</div>
                    <div class="kpi-subtext">From remediation</div>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    Compliance Issues - Triage View
                    <span class="badge" id="ops-compliance-badge">0 Open</span>
                </div>
                <div class="card-body">
                    <div class="table-scroll">
                        <table class="data-table" id="ops-compliance-table">
                            <thead>
                                <tr>
                                    <th>ServiceNow #</th>
                                    <th>Grant</th>
                                    <th>IRB #</th>
                                    <th>IRB Status</th>
                                    <th>Severity</th>
                                    <th>Type</th>
                                    <th>Environment</th>
                                    <th>PI</th>
                                    <th>Violation</th>
                                    <th class="text-right">Impact/Mo</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody id="ops-compliance-tbody"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div class="grid-2">
                <div class="card">
                    <div class="card-header">Issues by Type</div>
                    <div class="card-body">
                        <div class="chart-container"><canvas id="opsIssueTypeChart"></canvas></div>
                    </div>
                </div>
                <div class="card">
                    <div class="card-header">Issues by Severity</div>
                    <div class="card-body">
                        <div class="chart-container"><canvas id="opsSeverityChart"></canvas></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- PAGE: Governance -->
        <div id="page-governance" class="page">
            <div class="page-header">
                <div class="page-header-left">
                    <h2>Department Governance</h2>
                    <p>Department-level oversight with optional PI comparisons</p>
                </div>
                <div class="audience-badge governance">
                    <span>&#128203;</span> For: Department Chairs / Division Chiefs
                </div>
            </div>

            <div class="config-notice">
                <span>&#9881;</span>
                <span><strong>Configurable:</strong> PI comparisons are optional. Use the toggle below to enable/disable.</span>
            </div>

            <div style="margin-bottom: 20px;">
                <div class="toggle-switch">
                    <input type="checkbox" id="toggle-comparisons" onchange="toggleComparisons()">
                    <label for="toggle-comparisons">Show PI Comparisons</label>
                </div>
            </div>

            <div class="kpi-row">
                <div class="kpi-card">
                    <div class="kpi-label">Dept Total Spend</div>
                    <div class="kpi-value" id="kpi-gov-spend">--</div>
                    <div class="kpi-subtext">Year to Date</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-label">Dept Budget</div>
                    <div class="kpi-value" id="kpi-gov-budget">--</div>
                    <div class="kpi-subtext">Annual</div>
                </div>
                <div class="kpi-card success">
                    <div class="kpi-label">PIs in Dept</div>
                    <div class="kpi-value" id="kpi-gov-pis">--</div>
                    <div class="kpi-subtext">Active</div>
                </div>
                <div class="kpi-card info">
                    <div class="kpi-label">Compliance</div>
                    <div class="kpi-value" id="kpi-gov-compliance">--</div>
                    <div class="kpi-subtext">Dept average</div>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    PIs in Department
                    <span class="badge" id="gov-pi-badge">--</span>
                </div>
                <div class="card-body">
                    <div class="table-scroll">
                        <table class="data-table" id="gov-pi-table">
                            <thead>
                                <tr>
                                    <th>PI Name</th>
                                    <th>Division</th>
                                    <th class="text-right">YTD Spend</th>
                                    <th class="text-right">Budget</th>
                                    <th>Usage</th>
                                    <th>Budget Status</th>
                                    <th>Projects</th>
                                </tr>
                            </thead>
                            <tbody id="gov-pi-tbody"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="comparison-section" style="display: none;">
                <div class="grid-2">
                    <div class="card">
                        <div class="card-header">PI Spend Distribution</div>
                        <div class="card-body">
                            <div class="chart-container"><canvas id="govSpendChart"></canvas></div>
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-header">Budget Utilization by PI</div>
                        <div class="card-body">
                            <div class="chart-container"><canvas id="govBudgetChart"></canvas></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <footer class="footer">
        <p>University of Michigan Medicine - FinOps Cloud Cost Management Dashboard</p>
        <p>Data aligned to ServiceNow + Azure Cost Management | Confidential - Internal Use Only</p>
    </footer>

    <script>
        // ============================================
        // EXPANDED DATA WITH VARIED SCENARIOS
        // ============================================

        const DEPARTMENTS = {
            "DEPT-CARD": { name: "Cardiology", divisions: ["General Cardiology", "Interventional", "Electrophysiology"] },
            "DEPT-ONC": { name: "Oncology", divisions: ["Medical Oncology", "Surgical Oncology", "Radiation Oncology"] },
            "DEPT-NEUR": { name: "Neurology", divisions: ["General Neurology", "Movement Disorders", "Neuro-Oncology"] },
            "DEPT-PEDS": { name: "Pediatrics", divisions: ["General Pediatrics", "Peds Cardiology", "Peds Oncology"] },
            "DEPT-SURG": { name: "Surgery", divisions: ["General Surgery", "Vascular", "Transplant"] },
            "DEPT-PATH": { name: "Pathology", divisions: ["Anatomic", "Clinical", "Molecular"] },
            "DEPT-RADI": { name: "Radiology", divisions: ["Diagnostic", "Interventional", "Nuclear Medicine"] },
            "DEPT-PSYC": { name: "Psychiatry", divisions: ["Adult", "Child", "Addiction Medicine"] }
        };

        // EXPANDED GRANTS - Multiple per PI with varied budget scenarios
        const GRANTS = {
            // Dr. Sarah Chen - Cardiology (WITHIN BUDGET)
            "GRANT-NIH-HL-2024-01": { name: "NIH Heart & Lung Research 2024", dept: "DEPT-CARD", budget: 85000, pi: "Dr. Sarah Chen" },
            "GRANT-AHA-2025-02": { name: "AHA Cardiovascular Innovation", dept: "DEPT-CARD", budget: 45000, pi: "Dr. Sarah Chen" },

            // Dr. Michael Torres - Oncology (OVERSPEND)
            "GRANT-NIH-CA-2025-09": { name: "NIH Cancer Genomics 2025", dept: "DEPT-ONC", budget: 120000, pi: "Dr. Michael Torres" },
            "GRANT-NCI-2024-15": { name: "NCI Tumor Profiling", dept: "DEPT-ONC", budget: 80000, pi: "Dr. Michael Torres" },

            // Dr. Emily Watson - Neurology (AT RISK)
            "GRANT-NIH-NS-2024-15": { name: "NIH Neurological Studies", dept: "DEPT-NEUR", budget: 130000, pi: "Dr. Emily Watson" },

            // Dr. James Park - Pediatrics (COMPLETED + WITHIN BUDGET)
            "GRANT-PCORI-2025-03": { name: "PCORI Pediatric Outcomes", dept: "DEPT-PEDS", budget: 52000, pi: "Dr. James Park" },
            "GRANT-PEDS-2024-08": { name: "Pediatric Asthma Study (Completed)", dept: "DEPT-PEDS", budget: 35000, pi: "Dr. James Park" },

            // Dr. Amanda Foster - Surgery (WITHIN BUDGET)
            "GRANT-DOD-2024-22": { name: "DoD Surgical Innovation", dept: "DEPT-SURG", budget: 115000, pi: "Dr. Amanda Foster" },

            // Dr. Robert Kim - Pathology (OVERSPEND)
            "GRANT-NIH-AI-2025-07": { name: "NIH AI in Pathology", dept: "DEPT-PATH", budget: 65000, pi: "Dr. Robert Kim" },

            // Dr. Lisa Patel - Radiology (UNDERUTILIZED)
            "GRANT-AHRQ-2024-11": { name: "AHRQ Imaging Analytics", dept: "DEPT-RADI", budget: 95000, pi: "Dr. Lisa Patel" },

            // Dr. David Liu - Psychiatry (COMPLETED)
            "GRANT-NIMH-2025-04": { name: "NIMH Mental Health Data", dept: "DEPT-PSYC", budget: 45000, pi: "Dr. David Liu" },
            "GRANT-NIMH-2024-12": { name: "NIMH Depression Study (Completed)", dept: "DEPT-PSYC", budget: 55000, pi: "Dr. David Liu" },

            // Dr. Jennifer Adams - Cardiology (NEW PI - AT RISK)
            "GRANT-NIH-HL-2025-18": { name: "NIH Cardiac Imaging AI", dept: "DEPT-CARD", budget: 70000, pi: "Dr. Jennifer Adams" },

            // Dr. Kevin Wright - Oncology (WITHIN BUDGET)
            "GRANT-DOD-ONC-2025-05": { name: "DoD Cancer Screening", dept: "DEPT-ONC", budget: 90000, pi: "Dr. Kevin Wright" },

            // Dr. Maria Garcia - Neurology (COMPLETED + OVERSPEND on active)
            "GRANT-NINDS-2024-20": { name: "NINDS Stroke Prevention", dept: "DEPT-NEUR", budget: 60000, pi: "Dr. Maria Garcia" },
            "GRANT-NINDS-2023-11": { name: "NINDS MS Study (Completed)", dept: "DEPT-NEUR", budget: 75000, pi: "Dr. Maria Garcia" },

            // Dr. Thomas Brown - Surgery (SEVERE OVERSPEND - 130% over budget)
            "GRANT-DOD-SURG-2025-01": { name: "DoD Trauma Surgery AI", dept: "DEPT-SURG", budget: 55000, pi: "Dr. Thomas Brown" },
            "GRANT-NIH-SURG-2024-09": { name: "NIH Minimally Invasive Procedures", dept: "DEPT-SURG", budget: 48000, pi: "Dr. Thomas Brown" },

            // Dr. Rachel Lee - Pediatrics (OVERSPEND - 122% over budget)
            "GRANT-NIH-PEDS-2025-06": { name: "NIH Pediatric Cancer Genomics", dept: "DEPT-PEDS", budget: 62000, pi: "Dr. Rachel Lee" },
            "GRANT-PCORI-PEDS-2024-14": { name: "PCORI Childhood Diabetes Study", dept: "DEPT-PEDS", budget: 45000, pi: "Dr. Rachel Lee" }
        };

        // EXPANDED REQUESTS with varied statuses
        const REQUESTS = [
            // Dr. Sarah Chen - Cardiology (WITHIN BUDGET - 2 active projects)
            { RequestId: "RITM001001", CatalogItemName: "Cardiac Arrhythmia Genomics Analysis", PIName: "Dr. Sarah Chen", EnvironmentType: "Standard", DepartmentId: "DEPT-CARD", Division: "Electrophysiology", GrantId: "GRANT-NIH-HL-2024-01", ExpectedEndDate: "2026-10-15", RequestStatus: "Active", IRBNumber: "HUM00198234", IRBStatus: "Approved" },
            { RequestId: "RITM001010", CatalogItemName: "Heart Failure Predictive Analytics", PIName: "Dr. Sarah Chen", EnvironmentType: "Standard", DepartmentId: "DEPT-CARD", Division: "General Cardiology", GrantId: "GRANT-AHA-2025-02", ExpectedEndDate: "2026-08-30", RequestStatus: "Active", IRBNumber: "HUM00201456", IRBStatus: "Approved" },

            // Dr. Michael Torres - Oncology (OVERSPEND - high cost projects)
            { RequestId: "RITM001002", CatalogItemName: "Breast Cancer Biomarker Discovery (PHI)", PIName: "Dr. Michael Torres", EnvironmentType: "AVE", DepartmentId: "DEPT-ONC", Division: "Medical Oncology", GrantId: "GRANT-NIH-CA-2025-09", ExpectedEndDate: "2026-12-31", RequestStatus: "Active", IRBNumber: "HUM00187562", IRBStatus: "Approved" },
            { RequestId: "RITM001009", CatalogItemName: "Tumor Genomics Sequencing Cluster", PIName: "Dr. Michael Torres", EnvironmentType: "Standard", DepartmentId: "DEPT-ONC", Division: "Medical Oncology", GrantId: "GRANT-NCI-2024-15", ExpectedEndDate: "2026-06-30", RequestStatus: "Active", IRBNumber: "HUM00187562", IRBStatus: "Approved" },
            { RequestId: "RITM001020", CatalogItemName: "Cancer Drug Response Modeling", PIName: "Dr. Michael Torres", EnvironmentType: "AVE", DepartmentId: "DEPT-ONC", Division: "Medical Oncology", GrantId: "GRANT-NIH-CA-2025-09", ExpectedEndDate: "2026-09-15", RequestStatus: "Active", IRBNumber: "HUM00205891", IRBStatus: "Under Review" },

            // Dr. Emily Watson - Neurology (AT RISK - 85% budget used)
            { RequestId: "RITM001003", CatalogItemName: "Alzheimer's Disease MRI Processing", PIName: "Dr. Emily Watson", EnvironmentType: "Standard", DepartmentId: "DEPT-NEUR", Division: "Movement Disorders", GrantId: "GRANT-NIH-NS-2024-15", ExpectedEndDate: "2026-08-30", RequestStatus: "Active", IRBNumber: "HUM00176543", IRBStatus: "Approved" },
            { RequestId: "RITM001011", CatalogItemName: "Parkinson's Disease Registry (PHI)", PIName: "Dr. Emily Watson", EnvironmentType: "AVE", DepartmentId: "DEPT-NEUR", Division: "Movement Disorders", GrantId: "GRANT-NIH-NS-2024-15", ExpectedEndDate: "2026-08-30", RequestStatus: "Active", IRBNumber: "HUM00189234", IRBStatus: "Approved" },

            // Dr. James Park - Pediatrics (COMPLETED project + ACTIVE within budget)
            { RequestId: "RITM001004", CatalogItemName: "Pediatric Asthma Outcomes Study (PHI)", PIName: "Dr. James Park", EnvironmentType: "AVE", DepartmentId: "DEPT-PEDS", Division: "General Pediatrics", GrantId: "GRANT-PCORI-2025-03", ExpectedEndDate: "2026-02-15", RequestStatus: "Expiring", IRBNumber: "HUM00165432", IRBStatus: "Approved" },
            { RequestId: "RITM001021", CatalogItemName: "Childhood Obesity Analysis (Completed)", PIName: "Dr. James Park", EnvironmentType: "Standard", DepartmentId: "DEPT-PEDS", Division: "General Pediatrics", GrantId: "GRANT-PEDS-2024-08", ExpectedEndDate: "2025-12-31", RequestStatus: "Completed", IRBNumber: "HUM00154321", IRBStatus: "Closed" },

            // Dr. Amanda Foster - Surgery (WITHIN BUDGET)
            { RequestId: "RITM001005", CatalogItemName: "Robotic Surgery ML Training", PIName: "Dr. Amanda Foster", EnvironmentType: "Standard", DepartmentId: "DEPT-SURG", Division: "General Surgery", GrantId: "GRANT-DOD-2024-22", ExpectedEndDate: "2026-11-30", RequestStatus: "Active", IRBNumber: "N/A", IRBStatus: "Exempt" },
            { RequestId: "RITM001012", CatalogItemName: "Surgical Outcomes DevTest Sandbox", PIName: "Dr. Amanda Foster", EnvironmentType: "Standard", DepartmentId: "DEPT-SURG", Division: "General Surgery", GrantId: "GRANT-DOD-2024-22", ExpectedEndDate: "2026-03-15", RequestStatus: "Expiring", IRBNumber: "N/A", IRBStatus: "Exempt" },

            // Dr. Robert Kim - Pathology (OVERSPEND)
            { RequestId: "RITM001006", CatalogItemName: "Digital Pathology AI Diagnostics (PHI)", PIName: "Dr. Robert Kim", EnvironmentType: "AVE", DepartmentId: "DEPT-PATH", Division: "Molecular Pathology", GrantId: "GRANT-NIH-AI-2025-07", ExpectedEndDate: "2026-09-15", RequestStatus: "Active", IRBNumber: "HUM00192876", IRBStatus: "Approved" },
            { RequestId: "RITM001022", CatalogItemName: "Tissue Analysis GPU Cluster", PIName: "Dr. Robert Kim", EnvironmentType: "Standard", DepartmentId: "DEPT-PATH", Division: "Molecular Pathology", GrantId: "GRANT-NIH-AI-2025-07", ExpectedEndDate: "2026-07-30", RequestStatus: "Active", IRBNumber: "HUM00192876", IRBStatus: "Approved" },

            // Dr. Lisa Patel - Radiology (UNDERUTILIZED - only 25% budget used)
            { RequestId: "RITM001007", CatalogItemName: "CT Imaging Reconstruction Pipeline", PIName: "Dr. Lisa Patel", EnvironmentType: "Standard", DepartmentId: "DEPT-RADI", Division: "Diagnostic Radiology", GrantId: "GRANT-AHRQ-2024-11", ExpectedEndDate: "2026-06-30", RequestStatus: "Active", IRBNumber: "N/A", IRBStatus: "Exempt" },

            // Dr. David Liu - Psychiatry (COMPLETED + WITHIN BUDGET on active)
            { RequestId: "RITM001008", CatalogItemName: "Depression Treatment Response (PHI)", PIName: "Dr. David Liu", EnvironmentType: "AVE", DepartmentId: "DEPT-PSYC", Division: "Adult Psychiatry", GrantId: "GRANT-NIMH-2025-04", ExpectedEndDate: "2026-04-30", RequestStatus: "Active", IRBNumber: "HUM00178654", IRBStatus: "Approved" },
            { RequestId: "RITM001023", CatalogItemName: "Mental Health ML Models (Completed)", PIName: "Dr. David Liu", EnvironmentType: "Standard", DepartmentId: "DEPT-PSYC", Division: "Adult Psychiatry", GrantId: "GRANT-NIMH-2024-12", ExpectedEndDate: "2025-11-30", RequestStatus: "Completed", IRBNumber: "HUM00156789", IRBStatus: "Closed" },

            // Dr. Jennifer Adams - Cardiology (AT RISK - new PI)
            { RequestId: "RITM001024", CatalogItemName: "Cardiac MRI AI Analysis (PHI)", PIName: "Dr. Jennifer Adams", EnvironmentType: "AVE", DepartmentId: "DEPT-CARD", Division: "Interventional", GrantId: "GRANT-NIH-HL-2025-18", ExpectedEndDate: "2026-12-15", RequestStatus: "Active", IRBNumber: "HUM00207123", IRBStatus: "Approved" },
            { RequestId: "RITM001025", CatalogItemName: "Echo Analysis Pipeline", PIName: "Dr. Jennifer Adams", EnvironmentType: "Standard", DepartmentId: "DEPT-CARD", Division: "Interventional", GrantId: "GRANT-NIH-HL-2025-18", ExpectedEndDate: "2026-10-30", RequestStatus: "Active", IRBNumber: "HUM00207123", IRBStatus: "Approved" },

            // Dr. Kevin Wright - Oncology (WITHIN BUDGET)
            { RequestId: "RITM001026", CatalogItemName: "Cancer Screening ML Model", PIName: "Dr. Kevin Wright", EnvironmentType: "Standard", DepartmentId: "DEPT-ONC", Division: "Surgical Oncology", GrantId: "GRANT-DOD-ONC-2025-05", ExpectedEndDate: "2026-11-30", RequestStatus: "Active", IRBNumber: "HUM00203456", IRBStatus: "Pending" },

            // Dr. Maria Garcia - Neurology (COMPLETED + OVERSPEND on active)
            { RequestId: "RITM001027", CatalogItemName: "Stroke Risk Prediction (PHI)", PIName: "Dr. Maria Garcia", EnvironmentType: "AVE", DepartmentId: "DEPT-NEUR", Division: "General Neurology", GrantId: "GRANT-NINDS-2024-20", ExpectedEndDate: "2026-05-30", RequestStatus: "Active", IRBNumber: "HUM00185432", IRBStatus: "Approved" },
            { RequestId: "RITM001028", CatalogItemName: "MS Lesion Analysis (Completed)", PIName: "Dr. Maria Garcia", EnvironmentType: "Standard", DepartmentId: "DEPT-NEUR", Division: "Neuro-Oncology", GrantId: "GRANT-NINDS-2023-11", ExpectedEndDate: "2025-10-31", RequestStatus: "Completed", IRBNumber: "HUM00167890", IRBStatus: "Closed" },

            // Dr. Thomas Brown - Surgery (SEVERE OVERSPEND - 130% over budget, high compute costs)
            { RequestId: "RITM001029", CatalogItemName: "Trauma Surgery AI Training (PHI)", PIName: "Dr. Thomas Brown", EnvironmentType: "AVE", DepartmentId: "DEPT-SURG", Division: "General Surgery", GrantId: "GRANT-DOD-SURG-2025-01", ExpectedEndDate: "2026-12-31", RequestStatus: "Active", IRBNumber: "HUM00209876", IRBStatus: "Approved" },
            { RequestId: "RITM001030", CatalogItemName: "Surgical Video Analysis GPU Cluster", PIName: "Dr. Thomas Brown", EnvironmentType: "Standard", DepartmentId: "DEPT-SURG", Division: "General Surgery", GrantId: "GRANT-DOD-SURG-2025-01", ExpectedEndDate: "2026-09-30", RequestStatus: "Active", IRBNumber: "HUM00209876", IRBStatus: "Approved" },
            { RequestId: "RITM001031", CatalogItemName: "Minimally Invasive Procedure Modeling", PIName: "Dr. Thomas Brown", EnvironmentType: "Standard", DepartmentId: "DEPT-SURG", Division: "Vascular", GrantId: "GRANT-NIH-SURG-2024-09", ExpectedEndDate: "2026-06-30", RequestStatus: "Active", IRBNumber: "HUM00211234", IRBStatus: "Under Review" },

            // Dr. Rachel Lee - Pediatrics (OVERSPEND - 122% over budget)
            { RequestId: "RITM001032", CatalogItemName: "Pediatric Cancer Genomics Sequencing (PHI)", PIName: "Dr. Rachel Lee", EnvironmentType: "AVE", DepartmentId: "DEPT-PEDS", Division: "Peds Oncology", GrantId: "GRANT-NIH-PEDS-2025-06", ExpectedEndDate: "2026-11-30", RequestStatus: "Active", IRBNumber: "HUM00206543", IRBStatus: "Approved" },
            { RequestId: "RITM001033", CatalogItemName: "Childhood Leukemia ML Models", PIName: "Dr. Rachel Lee", EnvironmentType: "Standard", DepartmentId: "DEPT-PEDS", Division: "Peds Oncology", GrantId: "GRANT-NIH-PEDS-2025-06", ExpectedEndDate: "2026-08-30", RequestStatus: "Active", IRBNumber: "HUM00206543", IRBStatus: "Approved" },
            { RequestId: "RITM001034", CatalogItemName: "Diabetes Biomarker Analysis (PHI)", PIName: "Dr. Rachel Lee", EnvironmentType: "AVE", DepartmentId: "DEPT-PEDS", Division: "General Pediatrics", GrantId: "GRANT-PCORI-PEDS-2024-14", ExpectedEndDate: "2026-07-31", RequestStatus: "Active", IRBNumber: "HUM00208765", IRBStatus: "Pending" }
        ];

        // Generate environments from requests
        const ENVIRONMENTS = REQUESTS.map((r, idx) => ({
            EnvironmentId: r.EnvironmentType === 'AVE' ? `AVE-00${1001 + idx}` : `ENV-00${1001 + idx}`,
            RequestId: r.RequestId,
            EnvironmentStatus: r.RequestStatus === 'Completed' ? 'Decommissioned' : 'Active'
        }));

        // Enhanced Compliance Data
        const COMPLIANCE = [
            { EnvironmentId: "AVE-001002", PolicyName: "Encryption", ViolationType: "Unencrypted storage on PHI", IssueType: "Security", Severity: "Critical", NonCompliantFlag: true, EstimatedMonthlyImpactUSD: 0, RemediationStatus: "Open" },
            { EnvironmentId: "ENV-001011", PolicyName: "NetworkSecurity", ViolationType: "Public IP exposed", IssueType: "Security", Severity: "Critical", NonCompliantFlag: true, EstimatedMonthlyImpactUSD: 0, RemediationStatus: "Open" },
            { EnvironmentId: "AVE-001007", PolicyName: "DataRetention", ViolationType: "Backup policy missing", IssueType: "Security", Severity: "High", NonCompliantFlag: true, EstimatedMonthlyImpactUSD: 0, RemediationStatus: "Open" },
            { EnvironmentId: "ENV-001005", PolicyName: "IdleResources", ViolationType: "VM idle > 7 days", IssueType: "Cost", Severity: "Medium", NonCompliantFlag: true, EstimatedMonthlyImpactUSD: 450, RemediationStatus: "Pending" },
            { EnvironmentId: "ENV-001009", PolicyName: "IdleResources", ViolationType: "Unused disk attached", IssueType: "Cost", Severity: "Medium", NonCompliantFlag: true, EstimatedMonthlyImpactUSD: 180, RemediationStatus: "Open" },
            { EnvironmentId: "ENV-001012", PolicyName: "IdleResources", ViolationType: "DevTest unused 14+ days", IssueType: "Cost", Severity: "Low", NonCompliantFlag: true, EstimatedMonthlyImpactUSD: 320, RemediationStatus: "Pending" },
            { EnvironmentId: "ENV-001001", PolicyName: "RequiredTags", ViolationType: "Missing GrantId Tag", IssueType: "Hygiene", Severity: "Low", NonCompliantFlag: true, EstimatedMonthlyImpactUSD: 0, RemediationStatus: "Open" },
            { EnvironmentId: "ENV-001003", PolicyName: "RequiredTags", ViolationType: "Missing CostCenter Tag", IssueType: "Hygiene", Severity: "Low", NonCompliantFlag: true, EstimatedMonthlyImpactUSD: 0, RemediationStatus: "Open" },
            { EnvironmentId: "AVE-001008", PolicyName: "RequiredTags", ViolationType: "Missing PI Tag", IssueType: "Hygiene", Severity: "Low", NonCompliantFlag: true, EstimatedMonthlyImpactUSD: 0, RemediationStatus: "Pending" }
        ];

        // Cost generation with varied scenarios
        function generateMonthlyCosts() {
            const costs = [];
            const months = ['2025-02', '2025-03', '2025-04', '2025-05', '2025-06', '2025-07',
                           '2025-08', '2025-09', '2025-10', '2025-11', '2025-12', '2026-01'];

            // Cost profiles per PI scenario
            const piCostMultipliers = {
                "Dr. Sarah Chen": 0.55,      // Within budget
                "Dr. Michael Torres": 1.25,   // Overspend
                "Dr. Emily Watson": 0.85,     // At risk
                "Dr. James Park": 0.45,       // Within budget
                "Dr. Amanda Foster": 0.50,    // Within budget
                "Dr. Robert Kim": 1.15,       // Overspend
                "Dr. Lisa Patel": 0.22,       // Underutilized
                "Dr. David Liu": 0.40,        // Within budget
                "Dr. Jennifer Adams": 0.82,   // At risk
                "Dr. Kevin Wright": 0.55,     // Within budget
                "Dr. Maria Garcia": 1.10,     // Overspend
                "Dr. Thomas Brown": 1.30,     // SEVERE Overspend (130%)
                "Dr. Rachel Lee": 1.22        // Overspend (122%)
            };

            const envBaseCosts = {};
            ENVIRONMENTS.forEach((env, idx) => {
                const request = REQUESTS.find(r => r.RequestId === env.RequestId);
                const multiplier = piCostMultipliers[request?.PIName] || 0.5;
                const baseAmount = request?.EnvironmentType === 'AVE' ? 4500 : 2500;
                envBaseCosts[env.EnvironmentId] = baseAmount * multiplier;
            });

            const envToRequest = {};
            ENVIRONMENTS.forEach(e => envToRequest[e.EnvironmentId] = e.RequestId);

            const requestToGrant = {}, requestToDept = {};
            REQUESTS.forEach(r => {
                requestToGrant[r.RequestId] = r.GrantId;
                requestToDept[r.RequestId] = r.DepartmentId;
            });

            months.forEach((month, monthIdx) => {
                Object.keys(envBaseCosts).forEach(envId => {
                    const env = ENVIRONMENTS.find(e => e.EnvironmentId === envId);
                    const request = REQUESTS.find(r => r.RequestId === env?.RequestId);

                    // Skip costs for completed projects after their end date
                    if (request?.RequestStatus === 'Completed') {
                        const endMonth = request.ExpectedEndDate.substring(0, 7);
                        if (month > endMonth) return;
                    }

                    const requestId = envToRequest[envId];
                    const grantId = requestToGrant[requestId];
                    const deptId = requestToDept[requestId];

                    const growthFactor = 1 + (monthIdx * 0.012);
                    const randomFactor = 0.92 + Math.random() * 0.16;
                    const baseCost = (envBaseCosts[envId] || 2000) * growthFactor * randomFactor;

                    costs.push({ BillingMonth: month, EnvironmentId: envId, DepartmentId: deptId, GrantId: grantId, CostUSD: baseCost * 0.55, ServiceCategory: 'Compute' });
                    costs.push({ BillingMonth: month, EnvironmentId: envId, DepartmentId: deptId, GrantId: grantId, CostUSD: baseCost * 0.20, ServiceCategory: 'Storage' });
                    costs.push({ BillingMonth: month, EnvironmentId: envId, DepartmentId: deptId, GrantId: grantId, CostUSD: baseCost * 0.10, ServiceCategory: 'Networking' });
                    costs.push({ BillingMonth: month, EnvironmentId: envId, DepartmentId: deptId, GrantId: grantId, CostUSD: baseCost * 0.10, ServiceCategory: 'Security' });
                    costs.push({ BillingMonth: month, EnvironmentId: envId, DepartmentId: deptId, GrantId: grantId, CostUSD: baseCost * 0.05, ServiceCategory: 'Database' });
                });
            });
            return costs;
        }

        function generateMonthlyBudgets() {
            const budgets = [];
            const months = ['2025-02', '2025-03', '2025-04', '2025-05', '2025-06', '2025-07',
                           '2025-08', '2025-09', '2025-10', '2025-11', '2025-12', '2026-01'];
            Object.keys(GRANTS).forEach(grantId => {
                const grant = GRANTS[grantId];
                const monthlyBudget = grant.budget / 12;
                months.forEach(month => {
                    budgets.push({ BillingMonth: month, GrantId: grantId, DepartmentId: grant.dept, BudgetUSD: monthlyBudget });
                });
            });
            return budgets;
        }

        const DATA = {
            requests: REQUESTS,
            environments: ENVIRONMENTS,
            costMonthly: generateMonthlyCosts(),
            budgetMonthly: generateMonthlyBudgets(),
            compliance: COMPLIANCE
        };

        // ============================================
        // GLOBAL STATE & FILTERS
        // ============================================
        let currentPersona = 'finance';
        let currentPI = 'Dr. Sarah Chen';
        let showComparisons = false;

        let globalFilters = {
            dept: 'all',
            pi: 'all',
            status: 'all',
            budgetStatus: 'all',
            envType: 'all',
            dateRange: 'all'
        };

        let charts = {};

        // ============================================
        // GLOBAL FILTER FUNCTIONS
        // ============================================
        function applyGlobalFilters() {
            globalFilters.dept = document.getElementById('global-filter-dept').value;
            globalFilters.pi = document.getElementById('global-filter-pi').value;
            globalFilters.status = document.getElementById('global-filter-status').value;
            globalFilters.budgetStatus = document.getElementById('global-filter-budget').value;
            globalFilters.envType = document.getElementById('global-filter-env').value;
            globalFilters.dateRange = document.getElementById('global-filter-date').value;

            updateActiveFiltersDisplay();
            refreshAllViews();
        }

        function resetGlobalFilters() {
            document.getElementById('global-filter-dept').value = 'all';
            document.getElementById('global-filter-pi').value = 'all';
            document.getElementById('global-filter-status').value = 'all';
            document.getElementById('global-filter-budget').value = 'all';
            document.getElementById('global-filter-env').value = 'all';
            document.getElementById('global-filter-date').value = 'all';
            applyGlobalFilters();
        }

        function updateActiveFiltersDisplay() {
            const container = document.getElementById('active-filters-display');
            const tagsContainer = document.getElementById('active-filter-tags');
            tagsContainer.innerHTML = '';

            let hasFilters = false;

            if (globalFilters.dept !== 'all') {
                hasFilters = true;
                tagsContainer.innerHTML += `<span class="filter-tag">${DEPARTMENTS[globalFilters.dept].name} <span class="remove" onclick="clearFilter('dept')"></span></span>`;
            }
            if (globalFilters.pi !== 'all') {
                hasFilters = true;
                tagsContainer.innerHTML += `<span class="filter-tag">${globalFilters.pi} <span class="remove" onclick="clearFilter('pi')"></span></span>`;
            }
            if (globalFilters.status !== 'all') {
                hasFilters = true;
                tagsContainer.innerHTML += `<span class="filter-tag">${globalFilters.status} <span class="remove" onclick="clearFilter('status')"></span></span>`;
            }
            if (globalFilters.budgetStatus !== 'all') {
                hasFilters = true;
                const labels = { overspend: 'Over Budget', atrisk: 'At Risk', ontrack: 'On Track', underutilized: 'Underutilized' };
                tagsContainer.innerHTML += `<span class="filter-tag">${labels[globalFilters.budgetStatus]} <span class="remove" onclick="clearFilter('budgetStatus')"></span></span>`;
            }
            if (globalFilters.envType !== 'all') {
                hasFilters = true;
                tagsContainer.innerHTML += `<span class="filter-tag">${globalFilters.envType} <span class="remove" onclick="clearFilter('envType')"></span></span>`;
            }
            if (globalFilters.dateRange !== 'all') {
                hasFilters = true;
                const dateLabels = { '1': 'Last 1 Month', '3': 'Last 3 Months', '6': 'Last 6 Months', 'ytd': 'Year to Date' };
                tagsContainer.innerHTML += `<span class="filter-tag">${dateLabels[globalFilters.dateRange]} <span class="remove" onclick="clearFilter('dateRange')"></span></span>`;
            }

            container.className = hasFilters ? 'active-filters-display visible' : 'active-filters-display';
        }

        function clearFilter(filterName) {
            const filterMap = { budgetStatus: 'budget', envType: 'env', dateRange: 'date' };
            document.getElementById(`global-filter-${filterMap[filterName] || filterName}`).value = 'all';
            applyGlobalFilters();
        }

        // Get filtered requests based on global filters
        function getFilteredRequests() {
            return REQUESTS.filter(r => {
                if (globalFilters.dept !== 'all' && r.DepartmentId !== globalFilters.dept) return false;
                if (globalFilters.pi !== 'all' && r.PIName !== globalFilters.pi) return false;
                if (globalFilters.status !== 'all') {
                    if (globalFilters.status === 'Expiring' && r.RequestStatus !== 'Expiring') return false;
                    if (globalFilters.status !== 'Expiring' && r.RequestStatus !== globalFilters.status) return false;
                }
                if (globalFilters.envType !== 'all' && r.EnvironmentType !== globalFilters.envType) return false;
                return true;
            });
        }

        function getDateFilterMonths() {
            const allMonths = ['2025-02', '2025-03', '2025-04', '2025-05', '2025-06', '2025-07',
                               '2025-08', '2025-09', '2025-10', '2025-11', '2025-12', '2026-01'];
            if (globalFilters.dateRange === 'all') return allMonths;
            if (globalFilters.dateRange === 'ytd') return allMonths.filter(m => m.startsWith('2026') || m >= '2025-01');
            const numMonths = parseInt(globalFilters.dateRange);
            return allMonths.slice(-numMonths);
        }

        function getFilteredCosts() {
            const filteredRequests = getFilteredRequests();
            const filteredEnvIds = ENVIRONMENTS.filter(e =>
                filteredRequests.some(r => r.RequestId === e.RequestId)
            ).map(e => e.EnvironmentId);

            const validMonths = getDateFilterMonths();
            return DATA.costMonthly.filter(c => filteredEnvIds.includes(c.EnvironmentId) && validMonths.includes(c.BillingMonth));
        }

        function getFilteredBudgets() {
            const filteredRequests = getFilteredRequests();
            const grantIds = [...new Set(filteredRequests.map(r => r.GrantId))];
            const validMonths = getDateFilterMonths();
            return DATA.budgetMonthly.filter(b => grantIds.includes(b.GrantId) && validMonths.includes(b.BillingMonth));
        }

        function getBudgetStatus(pct) {
            if (pct > 100) return { status: 'overspend', label: 'Over Budget', class: 'budget-overspend' };
            if (pct > 80) return { status: 'atrisk', label: 'At Risk', class: 'budget-atrisk' };
            if (pct < 30) return { status: 'underutilized', label: 'Underutilized', class: 'budget-underutilized' };
            return { status: 'ontrack', label: 'On Track', class: 'budget-ontrack' };
        }

        function getIRBStatusClass(status) {
            const statusMap = {
                'Approved': 'irb-approved',
                'Pending': 'irb-pending',
                'Under Review': 'irb-under-review',
                'Exempt': 'irb-exempt',
                'Closed': 'irb-closed'
            };
            return statusMap[status] || 'irb-pending';
        }

        function refreshAllViews() {
            if (currentPersona === 'finance') updateFinanceView();
            if (currentPersona === 'pi') updatePIView();
            if (currentPersona === 'cloudops') updateOpsView();
            if (currentPersona === 'governance') updateGovView();
        }

        // ============================================
        // PERSONA SWITCHING
        // ============================================
        function switchPersona() {
            currentPersona = document.getElementById('persona-select').value;

            // Update current PI based on filter if in PI view
            if (currentPersona === 'pi' && globalFilters.pi !== 'all') {
                currentPI = globalFilters.pi;
            }

            updateNavigation();
            showDefaultPage();
        }

        function updateNavigation() {
            const navTabs = document.getElementById('nav-tabs');
            navTabs.innerHTML = '';

            const config = {
                finance: [{ id: 'page-finance', label: 'Cost Overview', hint: 'Leadership' }],
                pi: [{ id: 'page-pi', label: 'My Research', hint: 'Personal' }],
                cloudops: [{ id: 'page-cloudops', label: 'Compliance Triage', hint: 'IT/Security' }],
                governance: [{ id: 'page-governance', label: 'Department View', hint: 'Admin' }]
            };

            (config[currentPersona] || []).forEach((tab, idx) => {
                const btn = document.createElement('button');
                btn.className = 'nav-tab' + (idx === 0 ? ' active' : '');
                btn.onclick = () => showPage(tab.id);
                btn.innerHTML = `${tab.label} <span class="audience-hint">${tab.hint}</span>`;
                navTabs.appendChild(btn);
            });
        }

        function showDefaultPage() {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            const pageMap = { finance: 'page-finance', pi: 'page-pi', cloudops: 'page-cloudops', governance: 'page-governance' };
            document.getElementById(pageMap[currentPersona]).classList.add('active');
            refreshAllViews();
        }

        function showPage(pageId) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
            document.getElementById(pageId).classList.add('active');
            event.target.classList.add('active');
        }

        // ============================================
        // POPULATE FILTERS
        // ============================================
        function populateFilters() {
            const deptSelect = document.getElementById('global-filter-dept');
            Object.keys(DEPARTMENTS).forEach(deptId => {
                const opt = document.createElement('option');
                opt.value = deptId;
                opt.textContent = DEPARTMENTS[deptId].name;
                deptSelect.appendChild(opt);
            });

            const piSelect = document.getElementById('global-filter-pi');
            const piNames = [...new Set(REQUESTS.map(r => r.PIName))].sort();
            piNames.forEach(name => {
                const opt = document.createElement('option');
                opt.value = name;
                opt.textContent = name;
                piSelect.appendChild(opt);
            });
        }

        // ============================================
        // FINANCE VIEW
        // ============================================
        function updateFinanceView() {
            const costs = getFilteredCosts();
            const budgets = getFilteredBudgets();
            const filteredRequests = getFilteredRequests();

            const totalCost = costs.reduce((sum, c) => sum + c.CostUSD, 0);
            const totalBudget = budgets.reduce((sum, b) => sum + b.BudgetUSD, 0);
            const completedCount = filteredRequests.filter(r => r.RequestStatus === 'Completed').length;

            // Calculate overspend PIs
            const piData = calculatePIBudgetData(filteredRequests, costs, budgets);
            const overspendPIs = Object.values(piData).filter(p => p.pct > 100).length;

            document.getElementById('kpi-finance-ytd').textContent = formatCurrency(totalCost);
            document.getElementById('kpi-finance-budget').textContent = formatCurrency(totalBudget);
            document.getElementById('kpi-finance-variance').textContent = formatCurrency(totalBudget - totalCost);
            document.getElementById('kpi-finance-variance-sub').textContent = totalBudget > totalCost ? 'Under budget' : 'Over budget';
            document.getElementById('kpi-finance-overspend').textContent = overspendPIs;
            document.getElementById('kpi-finance-completed').textContent = completedCount;

            updateFinanceMatrix(filteredRequests, costs, budgets);
            updateFinanceProjectsTable(filteredRequests, costs, budgets);
            updateFinanceAnalysis(filteredRequests, costs, budgets, piData);
            renderFinanceCharts(costs, budgets);
        }

        function updateFinanceAnalysis(requests, costs, budgets, piData) {
            // Calculate Month-over-Month change
            const months = [...new Set(costs.map(c => c.BillingMonth))].sort();
            const monthlyTotals = {};
            months.forEach(m => {
                monthlyTotals[m] = costs.filter(c => c.BillingMonth === m).reduce((sum, c) => sum + c.CostUSD, 0);
            });

            const lastMonth = months[months.length - 1];
            const prevMonth = months[months.length - 2];
            const momChange = prevMonth && monthlyTotals[prevMonth] > 0
                ? ((monthlyTotals[lastMonth] - monthlyTotals[prevMonth]) / monthlyTotals[prevMonth] * 100)
                : 0;

            const momEl = document.getElementById('analysis-mom');
            momEl.textContent = `${momChange >= 0 ? '+' : ''}${momChange.toFixed(1)}%`;
            momEl.className = `analysis-value ${momChange > 0 ? 'negative' : 'positive'}`;
            document.getElementById('analysis-mom-detail').textContent = `${lastMonth || ''} vs ${prevMonth || ''}`;

            // Average Monthly Spend
            const avgSpend = months.length > 0 ? Object.values(monthlyTotals).reduce((a, b) => a + b, 0) / months.length : 0;
            document.getElementById('analysis-avg-spend').textContent = formatCurrency(avgSpend);
            document.getElementById('analysis-avg-detail').textContent = `across ${months.length} months`;

            // Projected Year-End (12 months)
            const projected = avgSpend * 12;
            document.getElementById('analysis-projected').textContent = formatCurrency(projected);
            const totalBudget = budgets.reduce((sum, b) => sum + b.BudgetUSD, 0);
            document.getElementById('analysis-projected-detail').textContent = projected > totalBudget ? 'Over annual budget' : 'Within annual budget';

            // Cost per Project
            const activeProjects = requests.filter(r => r.RequestStatus !== 'Completed').length;
            const perProject = activeProjects > 0 ? costs.reduce((sum, c) => sum + c.CostUSD, 0) / activeProjects : 0;
            document.getElementById('analysis-per-project').textContent = formatCurrency(perProject);
            document.getElementById('analysis-per-project-detail').textContent = `${activeProjects} active projects`;

            // Top Spending Departments
            const deptCosts = {};
            costs.forEach(c => {
                const deptId = c.DepartmentId;
                if (deptId) deptCosts[deptId] = (deptCosts[deptId] || 0) + c.CostUSD;
            });
            const topDepts = Object.entries(deptCosts).sort((a, b) => b[1] - a[1]).slice(0, 5);
            const maxDeptCost = topDepts.length > 0 ? topDepts[0][1] : 1;

            document.getElementById('top-departments-list').innerHTML = topDepts.map(([deptId, cost]) => `
                <div class="breakdown-item">
                    <span class="label">${DEPARTMENTS[deptId]?.name || deptId}</span>
                    <div class="bar-container"><div class="bar" style="width: ${(cost/maxDeptCost*100)}%"></div></div>
                    <span class="value">${formatCurrency(cost)}</span>
                </div>
            `).join('');

            // Cost by Service Category
            const serviceCosts = {};
            costs.forEach(c => {
                serviceCosts[c.ServiceCategory] = (serviceCosts[c.ServiceCategory] || 0) + c.CostUSD;
            });
            const sortedServices = Object.entries(serviceCosts).sort((a, b) => b[1] - a[1]);
            const maxServiceCost = sortedServices.length > 0 ? sortedServices[0][1] : 1;

            document.getElementById('service-category-list').innerHTML = sortedServices.map(([category, cost]) => `
                <div class="breakdown-item">
                    <span class="label">${category}</span>
                    <div class="bar-container"><div class="bar" style="width: ${(cost/maxServiceCost*100)}%; background: var(--umm-teal);"></div></div>
                    <span class="value">${formatCurrency(cost)}</span>
                </div>
            `).join('');

            // Budget Risk Summary
            const riskCounts = { overspend: 0, atrisk: 0, ontrack: 0, underutilized: 0 };
            Object.values(piData).forEach(p => {
                const status = getBudgetStatus(p.pct).status;
                riskCounts[status]++;
            });

            document.getElementById('budget-risk-list').innerHTML = `
                <div class="breakdown-item" style="background: #FFEBEE;">
                    <span class="label">Over Budget</span>
                    <span class="value" style="color: #C62828;">${riskCounts.overspend} PIs</span>
                </div>
                <div class="breakdown-item" style="background: #FFF8E1;">
                    <span class="label">At Risk (>80%)</span>
                    <span class="value" style="color: #F57F17;">${riskCounts.atrisk} PIs</span>
                </div>
                <div class="breakdown-item" style="background: #E8F5E9;">
                    <span class="label">On Track</span>
                    <span class="value" style="color: #2E7D32;">${riskCounts.ontrack} PIs</span>
                </div>
                <div class="breakdown-item" style="background: #E3F2FD;">
                    <span class="label">Underutilized (<30%)</span>
                    <span class="value" style="color: #1565C0;">${riskCounts.underutilized} PIs</span>
                </div>
            `;
        }

        function updateFinanceProjectsTable(requests, costs, budgets) {
            const tbody = document.getElementById('finance-projects-tbody');
            tbody.innerHTML = '';
            document.getElementById('finance-projects-badge').textContent = `${requests.length} Projects`;

            const costByEnv = {};
            costs.forEach(c => { costByEnv[c.EnvironmentId] = (costByEnv[c.EnvironmentId] || 0) + c.CostUSD; });

            const grantBudgets = {}, grantCosts = {};
            budgets.forEach(b => { grantBudgets[b.GrantId] = (grantBudgets[b.GrantId] || 0) + b.BudgetUSD; });
            costs.forEach(c => { grantCosts[c.GrantId] = (grantCosts[c.GrantId] || 0) + c.CostUSD; });

            requests.forEach(r => {
                const env = ENVIRONMENTS.find(e => e.RequestId === r.RequestId);
                const cost = env ? (costByEnv[env.EnvironmentId] || 0) : 0;
                const grantBudget = grantBudgets[r.GrantId] || 0;
                const grantCost = grantCosts[r.GrantId] || 0;
                const budgetPct = grantBudget > 0 ? (grantCost / grantBudget * 100) : 0;
                const budgetStatus = getBudgetStatus(budgetPct);

                const today = new Date();
                const endDate = new Date(r.ExpectedEndDate);
                const daysUntil = Math.ceil((endDate - today) / 86400000);

                let status = r.RequestStatus, statusClass = 'status-active';
                if (r.RequestStatus === 'Completed') { statusClass = 'status-completed'; }
                else if (daysUntil <= 0) { status = 'Expired'; statusClass = 'status-expired'; }
                else if (daysUntil <= 30) { status = 'Expiring'; statusClass = 'status-expiring'; }

                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><span class="servicenow-ticket">${r.RequestId}</span></td>
                    <td>${r.CatalogItemName}</td>
                    <td><span class="grant-name">${GRANTS[r.GrantId]?.name || r.GrantId}</span></td>
                    <td><span class="irb-number">${r.IRBNumber || 'N/A'}</span></td>
                    <td><span class="irb-status-badge ${getIRBStatusClass(r.IRBStatus)}">${r.IRBStatus || 'N/A'}</span></td>
                    <td>${r.PIName}</td>
                    <td>${DEPARTMENTS[r.DepartmentId]?.name || r.DepartmentId}</td>
                    <td><span class="env-type-badge ${r.EnvironmentType === 'AVE' ? 'env-ave' : 'env-standard'}">${r.EnvironmentType}</span></td>
                    <td class="text-right">${formatCurrency(cost / 12)}</td>
                    <td><span class="budget-status-badge ${budgetStatus.class}">${budgetStatus.label}</span></td>
                    <td>${formatDate(r.ExpectedEndDate)}</td>
                    <td><span class="status-badge ${statusClass}">${status}</span></td>
                `;
                tbody.appendChild(row);
            });
        }

        function calculatePIBudgetData(requests, costs, budgets) {
            const piData = {};
            const costByEnv = {};
            costs.forEach(c => { costByEnv[c.EnvironmentId] = (costByEnv[c.EnvironmentId] || 0) + c.CostUSD; });

            const grantBudgets = {};
            budgets.forEach(b => { grantBudgets[b.GrantId] = (grantBudgets[b.GrantId] || 0) + b.BudgetUSD; });

            requests.forEach(r => {
                if (!piData[r.PIName]) {
                    piData[r.PIName] = { cost: 0, budget: 0, dept: r.DepartmentId, division: r.Division, projects: 0, completed: 0, active: 0, endDates: [] };
                }
                const env = ENVIRONMENTS.find(e => e.RequestId === r.RequestId);
                if (env) piData[r.PIName].cost += costByEnv[env.EnvironmentId] || 0;
                piData[r.PIName].budget += grantBudgets[r.GrantId] || 0;
                piData[r.PIName].projects++;
                if (r.RequestStatus === 'Completed') piData[r.PIName].completed++;
                else {
                    piData[r.PIName].active++;
                    piData[r.PIName].endDates.push(r.ExpectedEndDate);
                }
            });

            Object.keys(piData).forEach(pi => {
                piData[pi].pct = piData[pi].budget > 0 ? (piData[pi].cost / piData[pi].budget * 100) : 0;
                // Get earliest end date for active projects
                if (piData[pi].endDates.length > 0) {
                    piData[pi].endDates.sort();
                    piData[pi].earliestEndDate = piData[pi].endDates[0];
                    piData[pi].latestEndDate = piData[pi].endDates[piData[pi].endDates.length - 1];
                }
            });

            return piData;
        }

        function updateFinanceMatrix(requests, costs, budgets) {
            const tbody = document.getElementById('finance-matrix-tbody');
            tbody.innerHTML = '';

            const piData = calculatePIBudgetData(requests, costs, budgets);

            // Apply budget status filter
            let filteredPIs = Object.keys(piData);
            if (globalFilters.budgetStatus !== 'all') {
                filteredPIs = filteredPIs.filter(pi => {
                    const status = getBudgetStatus(piData[pi].pct).status;
                    return status === globalFilters.budgetStatus;
                });
            }

            // Group by department
            const deptGroups = {};
            filteredPIs.forEach(pi => {
                const dept = piData[pi].dept;
                if (!deptGroups[dept]) deptGroups[dept] = [];
                deptGroups[dept].push(pi);
            });

            let grandCost = 0, grandBudget = 0;

            Object.keys(deptGroups).sort().forEach(deptId => {
                const pis = deptGroups[deptId];
                let deptCost = 0, deptBudget = 0, deptProjects = 0;

                pis.forEach(pi => {
                    deptCost += piData[pi].cost;
                    deptBudget += piData[pi].budget;
                    deptProjects += piData[pi].projects;
                });

                grandCost += deptCost;
                grandBudget += deptBudget;

                const deptPct = deptBudget > 0 ? (deptCost / deptBudget * 100) : 0;
                const deptStatus = getBudgetStatus(deptPct);

                // Get earliest end date for department
                let deptEarliestEnd = null;
                pis.forEach(pi => {
                    if (piData[pi].earliestEndDate) {
                        if (!deptEarliestEnd || piData[pi].earliestEndDate < deptEarliestEnd) {
                            deptEarliestEnd = piData[pi].earliestEndDate;
                        }
                    }
                });

                // Department row
                const deptRow = document.createElement('tr');
                deptRow.className = 'row-header expandable-row';
                deptRow.onclick = () => toggleExpand(deptId);
                deptRow.innerHTML = `
                    <td><span class="expand-icon" id="expand-${deptId}">&#9658;</span> <strong>${DEPARTMENTS[deptId].name}</strong></td>
                    <td>${formatCurrency(deptCost)}</td>
                    <td>${formatCurrency(deptBudget)}</td>
                    <td class="${deptBudget - deptCost >= 0 ? 'variance-positive' : 'variance-negative'}">${formatCurrency(deptBudget - deptCost)}</td>
                    <td>${deptPct.toFixed(1)}%</td>
                    <td><span class="budget-status-badge ${deptStatus.class}">${deptStatus.label}</span></td>
                    <td>${deptProjects}</td>
                    <td>${deptEarliestEnd ? formatDate(deptEarliestEnd) : '--'}</td>
                `;
                tbody.appendChild(deptRow);

                // PI rows
                pis.sort().forEach(pi => {
                    const p = piData[pi];
                    const status = getBudgetStatus(p.pct);
                    const piRow = document.createElement('tr');
                    piRow.className = 'child-row';
                    piRow.dataset.parent = deptId;
                    piRow.innerHTML = `
                        <td style="padding-left: 40px;">${pi} <span style="color:#888;font-size:11px;">(${p.division})</span></td>
                        <td>${formatCurrency(p.cost)}</td>
                        <td>${formatCurrency(p.budget)}</td>
                        <td class="${p.budget - p.cost >= 0 ? 'variance-positive' : 'variance-negative'}">${formatCurrency(p.budget - p.cost)}</td>
                        <td>${p.pct.toFixed(1)}%</td>
                        <td><span class="budget-status-badge ${status.class}">${status.label}</span></td>
                        <td>${p.active} active, ${p.completed} done</td>
                        <td>${p.earliestEndDate ? formatDate(p.earliestEndDate) : '--'}</td>
                    `;
                    tbody.appendChild(piRow);
                });
            });

            // Grand total
            const grandPct = grandBudget > 0 ? (grandCost / grandBudget * 100) : 0;
            const totalRow = document.createElement('tr');
            totalRow.className = 'subtotal';
            totalRow.innerHTML = `
                <td><strong>Grand Total</strong></td>
                <td><strong>${formatCurrency(grandCost)}</strong></td>
                <td><strong>${formatCurrency(grandBudget)}</strong></td>
                <td class="${grandBudget - grandCost >= 0 ? 'variance-positive' : 'variance-negative'}"><strong>${formatCurrency(grandBudget - grandCost)}</strong></td>
                <td><strong>${grandPct.toFixed(1)}%</strong></td>
                <td></td>
                <td><strong>${requests.length}</strong></td>
                <td></td>
            `;
            tbody.appendChild(totalRow);
        }

        function toggleExpand(id) {
            const icon = document.getElementById(`expand-${id}`);
            const rows = document.querySelectorAll(`tr[data-parent="${id}"]`);
            const expanded = icon.classList.toggle('expanded');
            rows.forEach(r => r.classList.toggle('visible', expanded));
        }

        function renderFinanceCharts(costs, budgets) {
            // Trend Chart
            const ctx1 = document.getElementById('financeSpendTrendChart');
            if (ctx1) {
                if (charts.financeSpendTrend) charts.financeSpendTrend.destroy();
                const months = [...new Set(costs.map(c => c.BillingMonth))].sort();
                const monthlyTotals = {}, monthlyBudgets = {};
                months.forEach(m => {
                    monthlyTotals[m] = costs.filter(c => c.BillingMonth === m).reduce((sum, c) => sum + c.CostUSD, 0);
                    monthlyBudgets[m] = budgets.filter(b => b.BillingMonth === m).reduce((sum, b) => sum + b.BudgetUSD, 0);
                });

                charts.financeSpendTrend = new Chart(ctx1, {
                    type: 'line',
                    data: {
                        labels: months.map(formatMonth),
                        datasets: [
                            { label: 'Actual', data: months.map(m => monthlyTotals[m]), borderColor: '#00274C', backgroundColor: 'rgba(0,39,76,0.1)', fill: true, tension: 0.3 },
                            { label: 'Budget', data: months.map(m => monthlyBudgets[m]), borderColor: '#FFCB05', borderDash: [5, 5], fill: false }
                        ]
                    },
                    options: {
                        responsive: true, maintainAspectRatio: false,
                        plugins: { legend: { position: 'bottom' } },
                        scales: { y: { beginAtZero: true, ticks: { callback: v => '$' + (v/1000).toFixed(0) + 'K' } } }
                    }
                });
            }

            // Budget Chart
            const ctx2 = document.getElementById('financeBudgetChart');
            if (ctx2) {
                if (charts.financeBudget) charts.financeBudget.destroy();
                const deptTotals = {}, deptBudgets = {};
                costs.forEach(c => { deptTotals[c.DepartmentId] = (deptTotals[c.DepartmentId] || 0) + c.CostUSD; });
                budgets.forEach(b => { deptBudgets[b.DepartmentId] = (deptBudgets[b.DepartmentId] || 0) + b.BudgetUSD; });
                const depts = Object.keys(deptTotals);

                charts.financeBudget = new Chart(ctx2, {
                    type: 'bar',
                    data: {
                        labels: depts.map(d => DEPARTMENTS[d]?.name || d),
                        datasets: [
                            { label: 'Actual', data: depts.map(d => deptTotals[d]), backgroundColor: '#00274C' },
                            { label: 'Budget', data: depts.map(d => deptBudgets[d]), backgroundColor: '#FFCB05' }
                        ]
                    },
                    options: {
                        responsive: true, maintainAspectRatio: false,
                        plugins: { legend: { position: 'bottom' } },
                        scales: { y: { beginAtZero: true, ticks: { callback: v => '$' + (v/1000).toFixed(0) + 'K' } } }
                    }
                });
            }
        }

        // ============================================
        // PI VIEW
        // ============================================
        function updatePIView() {
            // Use global PI filter if set, otherwise use currentPI
            const selectedPI = globalFilters.pi !== 'all' ? globalFilters.pi : currentPI;

            let piRequests = REQUESTS.filter(r => r.PIName === selectedPI);

            // Apply other global filters
            if (globalFilters.dept !== 'all') piRequests = piRequests.filter(r => r.DepartmentId === globalFilters.dept);
            if (globalFilters.status !== 'all') {
                if (globalFilters.status === 'Expiring') piRequests = piRequests.filter(r => r.RequestStatus === 'Expiring');
                else piRequests = piRequests.filter(r => r.RequestStatus === globalFilters.status);
            }
            if (globalFilters.envType !== 'all') piRequests = piRequests.filter(r => r.EnvironmentType === globalFilters.envType);

            const piEnvIds = ENVIRONMENTS.filter(e => piRequests.some(r => r.RequestId === e.RequestId)).map(e => e.EnvironmentId);
            const piGrantIds = [...new Set(piRequests.map(r => r.GrantId))];

            const piCosts = DATA.costMonthly.filter(c => piEnvIds.includes(c.EnvironmentId));
            const piBudgets = DATA.budgetMonthly.filter(b => piGrantIds.includes(b.GrantId));

            const totalCost = piCosts.reduce((sum, c) => sum + c.CostUSD, 0);
            const totalBudget = piBudgets.reduce((sum, b) => sum + b.BudgetUSD, 0);
            const budgetPct = totalBudget > 0 ? (totalCost / totalBudget * 100) : 0;

            // Update banner
            const initials = selectedPI.replace('Dr. ', '').split(' ').map(n => n[0]).join('');
            document.getElementById('pi-avatar').textContent = initials;
            document.getElementById('pi-name').textContent = selectedPI;
            const deptId = piRequests[0]?.DepartmentId;
            document.getElementById('pi-dept').textContent = deptId ? `Department of ${DEPARTMENTS[deptId].name}` : '';

            const today = new Date();
            const expiring = piRequests.filter(r => {
                if (r.RequestStatus === 'Completed') return false;
                const days = Math.ceil((new Date(r.ExpectedEndDate) - today) / 86400000);
                return days > 0 && days <= 30;
            }).length;

            const activeProjects = piRequests.filter(r => r.RequestStatus === 'Active' || r.RequestStatus === 'Expiring').length;

            document.getElementById('kpi-pi-spend').textContent = formatCurrency(totalCost);
            document.getElementById('kpi-pi-remaining').textContent = formatCurrency(totalBudget - totalCost);
            document.getElementById('kpi-pi-pct').textContent = `${budgetPct.toFixed(0)}% of budget used`;
            document.getElementById('kpi-pi-expiring').textContent = expiring;
            document.getElementById('kpi-pi-projects').textContent = activeProjects;

            updatePITables(piRequests, piCosts, piBudgets, piGrantIds);
        }

        function updatePITables(requests, costs, budgets, grantIds) {
            // Projects table
            const tbody = document.getElementById('pi-projects-tbody');
            tbody.innerHTML = '';
            document.getElementById('pi-project-count').textContent = `${requests.length} Projects`;

            const costByEnv = {};
            costs.forEach(c => { costByEnv[c.EnvironmentId] = (costByEnv[c.EnvironmentId] || 0) + c.CostUSD; });

            const grantBudgets = {}, grantCosts = {};
            budgets.forEach(b => { grantBudgets[b.GrantId] = (grantBudgets[b.GrantId] || 0) + b.BudgetUSD; });
            costs.forEach(c => { grantCosts[c.GrantId] = (grantCosts[c.GrantId] || 0) + c.CostUSD; });

            requests.forEach(r => {
                const env = ENVIRONMENTS.find(e => e.RequestId === r.RequestId);
                const cost = env ? (costByEnv[env.EnvironmentId] || 0) : 0;
                const grantBudget = grantBudgets[r.GrantId] || 0;
                const grantCost = grantCosts[r.GrantId] || 0;
                const budgetPct = grantBudget > 0 ? (grantCost / grantBudget * 100) : 0;
                const progressClass = budgetPct > 100 ? 'danger' : budgetPct > 80 ? 'warning' : 'good';

                const today = new Date();
                const endDate = new Date(r.ExpectedEndDate);
                const daysUntil = Math.ceil((endDate - today) / 86400000);

                let status = r.RequestStatus, statusClass = 'status-active';
                if (r.RequestStatus === 'Completed') { statusClass = 'status-completed'; }
                else if (daysUntil <= 0) { status = 'Expired'; statusClass = 'status-expired'; }
                else if (daysUntil <= 30) { status = 'Expiring'; statusClass = 'status-expiring'; }

                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><span class="servicenow-ticket">${r.RequestId}</span></td>
                    <td>${r.CatalogItemName}</td>
                    <td><span class="grant-name">${GRANTS[r.GrantId]?.name || r.GrantId}</span></td>
                    <td><span class="irb-number">${r.IRBNumber || 'N/A'}</span></td>
                    <td><span class="irb-status-badge ${getIRBStatusClass(r.IRBStatus)}">${r.IRBStatus || 'N/A'}</span></td>
                    <td><span class="env-type-badge ${r.EnvironmentType === 'AVE' ? 'env-ave' : 'env-standard'}">${r.EnvironmentType}</span></td>
                    <td class="text-right">${formatCurrency(cost / 12)}</td>
                    <td>
                        <div style="min-width:80px;">
                            <div style="font-size:11px;color:#666;">${budgetPct.toFixed(0)}%</div>
                            <div class="progress-bar"><div class="progress-fill ${progressClass}" style="width:${Math.min(budgetPct, 100)}%"></div></div>
                        </div>
                    </td>
                    <td>${formatDate(r.ExpectedEndDate)}</td>
                    <td><span class="status-badge ${statusClass}">${status}</span></td>
                `;
                tbody.appendChild(row);
            });

            // Grants table
            const grantsTbody = document.getElementById('pi-grants-tbody');
            grantsTbody.innerHTML = '';

            grantIds.forEach(grantId => {
                const cost = grantCosts[grantId] || 0;
                const budget = grantBudgets[grantId] || 0;
                const pct = budget > 0 ? (cost / budget * 100) : 0;
                const progressClass = pct > 100 ? 'danger' : pct > 80 ? 'warning' : 'good';
                const status = getBudgetStatus(pct);

                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${GRANTS[grantId]?.name || grantId}</td>
                    <td class="text-right">${formatCurrency(cost)}</td>
                    <td class="text-right">${formatCurrency(budget)}</td>
                    <td class="text-right ${budget - cost >= 0 ? 'variance-positive' : 'variance-negative'}">${formatCurrency(budget - cost)}</td>
                    <td>
                        <div style="min-width:100px;">
                            <div style="font-size:11px;color:#666;">${pct.toFixed(0)}%</div>
                            <div class="progress-bar"><div class="progress-fill ${progressClass}" style="width:${Math.min(pct, 100)}%"></div></div>
                        </div>
                    </td>
                    <td><span class="budget-status-badge ${status.class}">${status.label}</span></td>
                `;
                grantsTbody.appendChild(row);
            });
        }

        // ============================================
        // CLOUD OPS VIEW
        // ============================================
        function updateOpsView() {
            let compliance = DATA.compliance.filter(c => {
                const env = ENVIRONMENTS.find(e => e.EnvironmentId === c.EnvironmentId);
                const request = env ? REQUESTS.find(r => r.RequestId === env.RequestId) : null;

                if (globalFilters.dept !== 'all' && request?.DepartmentId !== globalFilters.dept) return false;
                if (globalFilters.pi !== 'all' && request?.PIName !== globalFilters.pi) return false;
                if (globalFilters.envType !== 'all') {
                    const isAVE = c.EnvironmentId.startsWith('AVE');
                    if (globalFilters.envType === 'AVE' && !isAVE) return false;
                    if (globalFilters.envType === 'Standard' && isAVE) return false;
                }
                return true;
            });

            const openIssues = compliance.filter(c => c.NonCompliantFlag && c.RemediationStatus !== 'Closed');
            const bySeverity = { Critical: 0, High: 0, Medium: 0, Low: 0 };
            openIssues.forEach(c => { bySeverity[c.Severity]++; });

            document.getElementById('triage-critical').textContent = bySeverity.Critical;
            document.getElementById('triage-high').textContent = bySeverity.High;
            document.getElementById('triage-medium').textContent = bySeverity.Medium;
            document.getElementById('triage-low').textContent = bySeverity.Low;

            const filteredEnvs = getFilteredRequests().length;
            const compliantCount = compliance.filter(c => !c.NonCompliantFlag || c.RemediationStatus === 'Closed').length;
            const complianceRate = compliance.length > 0 ? (compliantCount / compliance.length * 100) : 100;
            const estSavings = openIssues.reduce((sum, c) => sum + c.EstimatedMonthlyImpactUSD, 0);

            document.getElementById('kpi-ops-issues').textContent = openIssues.length;
            document.getElementById('kpi-ops-envs').textContent = filteredEnvs;
            document.getElementById('kpi-ops-rate').textContent = `${complianceRate.toFixed(0)}%`;
            document.getElementById('kpi-ops-savings').textContent = formatCurrency(estSavings);
            document.getElementById('ops-compliance-badge').textContent = `${openIssues.length} Open`;

            // Compliance table
            const tbody = document.getElementById('ops-compliance-tbody');
            tbody.innerHTML = '';

            const severityOrder = { Critical: 0, High: 1, Medium: 2, Low: 3 };
            const sorted = [...compliance].sort((a, b) => severityOrder[a.Severity] - severityOrder[b.Severity]);

            sorted.forEach(c => {
                const env = ENVIRONMENTS.find(e => e.EnvironmentId === c.EnvironmentId);
                const request = env ? REQUESTS.find(r => r.RequestId === env.RequestId) : null;

                let statusClass = 'status-open';
                if (c.RemediationStatus === 'Closed') statusClass = 'status-closed';
                else if (c.RemediationStatus === 'Pending') statusClass = 'status-pending';

                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><span class="servicenow-ticket">${request?.RequestId || 'N/A'}</span></td>
                    <td><span class="grant-name">${request ? (GRANTS[request.GrantId]?.name || request.GrantId) : 'N/A'}</span></td>
                    <td><span class="irb-number">${request?.IRBNumber || 'N/A'}</span></td>
                    <td><span class="irb-status-badge ${getIRBStatusClass(request?.IRBStatus)}">${request?.IRBStatus || 'N/A'}</span></td>
                    <td><span class="severity-badge severity-${c.Severity.toLowerCase()}">${c.Severity}</span></td>
                    <td><span class="issue-type-badge issue-${c.IssueType.toLowerCase()}">${c.IssueType}</span></td>
                    <td>${c.EnvironmentId}</td>
                    <td>${request?.PIName || 'N/A'}</td>
                    <td>${c.ViolationType}</td>
                    <td class="text-right">${formatCurrency(c.EstimatedMonthlyImpactUSD)}</td>
                    <td><span class="status-badge ${statusClass}">${c.RemediationStatus}</span></td>
                `;
                tbody.appendChild(row);
            });

            renderOpsCharts(compliance);
        }

        function renderOpsCharts(compliance) {
            const ctx1 = document.getElementById('opsIssueTypeChart');
            if (ctx1) {
                if (charts.opsIssueType) charts.opsIssueType.destroy();
                const byType = { Security: 0, Cost: 0, Hygiene: 0 };
                compliance.filter(c => c.NonCompliantFlag).forEach(c => { byType[c.IssueType]++; });

                charts.opsIssueType = new Chart(ctx1, {
                    type: 'doughnut',
                    data: {
                        labels: Object.keys(byType),
                        datasets: [{ data: Object.values(byType), backgroundColor: ['#C62828', '#1565C0', '#6A1B9A'], borderWidth: 2, borderColor: '#fff' }]
                    },
                    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'right' } } }
                });
            }

            const ctx2 = document.getElementById('opsSeverityChart');
            if (ctx2) {
                if (charts.opsSeverity) charts.opsSeverity.destroy();
                const bySev = { Critical: 0, High: 0, Medium: 0, Low: 0 };
                compliance.filter(c => c.NonCompliantFlag).forEach(c => { bySev[c.Severity]++; });

                charts.opsSeverity = new Chart(ctx2, {
                    type: 'bar',
                    data: {
                        labels: Object.keys(bySev),
                        datasets: [{ data: Object.values(bySev), backgroundColor: ['#C62828', '#E65100', '#F9A825', '#9E9E9E'] }]
                    },
                    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true } } }
                });
            }
        }

        // ============================================
        // GOVERNANCE VIEW
        // ============================================
        function toggleComparisons() {
            showComparisons = document.getElementById('toggle-comparisons').checked;
            document.getElementById('comparison-section').style.display = showComparisons ? 'block' : 'none';
            if (showComparisons) renderGovCharts();
        }

        function updateGovView() {
            const deptId = globalFilters.dept !== 'all' ? globalFilters.dept : 'DEPT-CARD';

            let deptRequests = REQUESTS.filter(r => r.DepartmentId === deptId);
            if (globalFilters.pi !== 'all') deptRequests = deptRequests.filter(r => r.PIName === globalFilters.pi);
            if (globalFilters.status !== 'all') {
                if (globalFilters.status === 'Expiring') deptRequests = deptRequests.filter(r => r.RequestStatus === 'Expiring');
                else deptRequests = deptRequests.filter(r => r.RequestStatus === globalFilters.status);
            }
            if (globalFilters.envType !== 'all') deptRequests = deptRequests.filter(r => r.EnvironmentType === globalFilters.envType);

            const deptPIs = [...new Set(deptRequests.map(r => r.PIName))];
            const deptEnvIds = ENVIRONMENTS.filter(e => deptRequests.some(r => r.RequestId === e.RequestId)).map(e => e.EnvironmentId);
            const deptGrantIds = [...new Set(deptRequests.map(r => r.GrantId))];

            const deptCosts = DATA.costMonthly.filter(c => deptEnvIds.includes(c.EnvironmentId));
            const deptBudgets = DATA.budgetMonthly.filter(b => deptGrantIds.includes(b.GrantId));

            const totalCost = deptCosts.reduce((sum, c) => sum + c.CostUSD, 0);
            const totalBudget = deptBudgets.reduce((sum, b) => sum + b.BudgetUSD, 0);

            const deptCompliance = DATA.compliance.filter(c => deptEnvIds.includes(c.EnvironmentId));
            const compliant = deptCompliance.filter(c => !c.NonCompliantFlag || c.RemediationStatus === 'Closed').length;
            const compRate = deptCompliance.length > 0 ? (compliant / deptCompliance.length * 100) : 100;

            // PI Table
            const tbody = document.getElementById('gov-pi-tbody');
            tbody.innerHTML = '';

            const costByEnv = {};
            DATA.costMonthly.forEach(c => { costByEnv[c.EnvironmentId] = (costByEnv[c.EnvironmentId] || 0) + c.CostUSD; });

            const grantBudgets = {};
            DATA.budgetMonthly.forEach(b => { grantBudgets[b.GrantId] = (grantBudgets[b.GrantId] || 0) + b.BudgetUSD; });

            // Pre-calculate PI budget status for filtering
            const piDataForFilter = {};
            deptPIs.forEach(piName => {
                const piRequests = deptRequests.filter(r => r.PIName === piName);
                const piEnvIds = ENVIRONMENTS.filter(e => piRequests.some(r => r.RequestId === e.RequestId)).map(e => e.EnvironmentId);
                let piCost = 0, piBudget = 0;
                piEnvIds.forEach(envId => { piCost += costByEnv[envId] || 0; });
                piRequests.forEach(r => { piBudget += grantBudgets[r.GrantId] || 0; });
                const pct = piBudget > 0 ? (piCost / piBudget * 100) : 0;
                piDataForFilter[piName] = { cost: piCost, budget: piBudget, pct, status: getBudgetStatus(pct), requests: piRequests, envIds: piEnvIds };
            });

            // Apply budget status filter
            let filteredPIs = deptPIs;
            if (globalFilters.budgetStatus !== 'all') {
                filteredPIs = deptPIs.filter(pi => piDataForFilter[pi].status.status === globalFilters.budgetStatus);
            }

            // Calculate totals from filtered PIs
            let filteredCost = 0, filteredBudget = 0;
            filteredPIs.forEach(pi => {
                filteredCost += piDataForFilter[pi].cost;
                filteredBudget += piDataForFilter[pi].budget;
            });

            document.getElementById('kpi-gov-spend').textContent = formatCurrency(filteredCost);
            document.getElementById('kpi-gov-budget').textContent = formatCurrency(filteredBudget);
            document.getElementById('kpi-gov-pis').textContent = filteredPIs.length;
            document.getElementById('kpi-gov-compliance').textContent = `${compRate.toFixed(0)}%`;
            document.getElementById('gov-pi-badge').textContent = `${filteredPIs.length} PIs`;

            filteredPIs.forEach(piName => {
                const p = piDataForFilter[piName];
                const progressClass = p.pct > 100 ? 'danger' : p.pct > 80 ? 'warning' : 'good';
                const division = p.requests[0]?.Division || 'N/A';
                const activeCount = p.requests.filter(r => r.RequestStatus !== 'Completed').length;

                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${piName}</td>
                    <td>${division}</td>
                    <td class="text-right">${formatCurrency(p.cost)}</td>
                    <td class="text-right">${formatCurrency(p.budget)}</td>
                    <td>
                        <div style="min-width:80px;">
                            <div style="font-size:11px;color:#666;">${p.pct.toFixed(0)}%</div>
                            <div class="progress-bar"><div class="progress-fill ${progressClass}" style="width:${Math.min(p.pct, 100)}%"></div></div>
                        </div>
                    </td>
                    <td><span class="budget-status-badge ${p.status.class}">${p.status.label}</span></td>
                    <td>${activeCount}</td>
                `;
                tbody.appendChild(row);
            });

            if (showComparisons) renderGovCharts();
        }

        function renderGovCharts() {
            // Placeholder for governance charts
        }

        // ============================================
        // UTILITIES
        // ============================================
        function formatCurrency(v) {
            return '$' + v.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        }

        function formatDate(d) {
            return new Date(d).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
        }

        function formatMonth(m) {
            const [y, mo] = m.split('-');
            return new Date(y, parseInt(mo) - 1).toLocaleDateString('en-US', { month: 'short', year: 'numeric' });
        }

        // ============================================
        // INITIALIZATION
        // ============================================
        document.addEventListener('DOMContentLoaded', function() {
            const loading = document.getElementById('loading-overlay');
            loading.style.display = 'flex';

            setTimeout(() => {
                const now = new Date();
                document.getElementById('currentDate').textContent = now.toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' });
                document.getElementById('lastSyncTime').textContent = now.toLocaleString('en-US', { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' });
                document.getElementById('approvalDate').textContent = new Date(now - 2 * 86400000).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });

                populateFilters();
                updateNavigation();
                showDefaultPage();

                loading.style.display = 'none';
            }, 300);
        });
    </script>
</body>
</html>
